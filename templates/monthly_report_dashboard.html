{% extends "base.html" %}

{% block title %}Monthly Report Dashboard - Email Guardian{% endblock %}

{% block extra_css %}
<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .border-left-primary {
        border-left: 0.25rem solid #007bff !important;
    }

    .border-left-danger {
        border-left: 0.25rem solid #dc3545 !important;
    }

    .border-left-success {
        border-left: 0.25rem solid #28a745 !important;
    }

    .border-left-warning {
        border-left: 0.25rem solid #ffc107 !important;
    }

    .opacity-25 {
        opacity: 0.25;
    }

    .chart-container {
        position: relative;
    }

    .card-header.bg-light {
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6;
    }

    .text-xs {
        font-size: 0.75rem;
    }

    .font-weight-bold {
        font-weight: 700 !important;
    }

    .text-gray-800 {
        color: #5a5c69 !important;
    }

    .shadow-sm {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
    }

    .card {
        transition: transform 0.2s ease-in-out;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .form-select-sm {
        padding: 0.25rem 2rem 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .form-control-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .gap-1 {
        gap: 0.25rem;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    /* Compact spacing */
    .mb-3 {
        margin-bottom: 1rem !important;
    }

    .py-2 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    .py-3 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
    }

    .p-3 {
        padding: 1rem !important;
    }

    .h3 {
        font-size: 1.75rem;
    }

    .h4 {
        font-size: 1.5rem;
    }

    .h6 {
        font-size: 1rem;
    }

    /* Fix column layout for summary cards */
    .summary-cards-row {
        display: flex !important;
        flex-wrap: wrap !important;
        margin: 0 -8px;
    }

    .summary-card-col {
        flex: 0 0 25% !important;
        max-width: 25% !important;
        padding: 0 8px !important;
        margin-bottom: 16px !important;
    }

    @media (max-width: 992px) {
        .summary-card-col {
            flex: 0 0 50% !important;
            max-width: 50% !important;
        }
    }

    @media (max-width: 576px) {
        .summary-card-col {
            flex: 0 0 100% !important;
            max-width: 100% !important;
        }
    }

    .card-compact {
        height: 100%;
        min-height: 120px;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Upload</a></li>
<li class="breadcrumb-item active">Monthly Report</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Compact Page Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm border-0 bg-gradient-primary text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-1 font-weight-bold">
                                <i class="fas fa-shield-alt me-2"></i>Monthly Email Security Report
                            </h1>
                            <p class="mb-0 opacity-75">Comprehensive security analysis dashboard</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light btn-sm" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportMonthlyReport()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="btn btn-info btn-sm" onclick="exportExcelReport()">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Session Selection Panel -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0 font-weight-bold text-primary">
                        <i class="fas fa-database me-1"></i>Data Sources Selection
                    </h6>
                </div>
                <div class="card-body py-3">
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label small font-weight-bold">Available Sessions</label>
                            <div class="border rounded p-2" style="height: 150px; overflow-y: auto; background-color: #f8f9fa;">
                                <div id="availableSessions"></div>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <button class="btn btn-outline-primary btn-sm mb-2" onclick="moveToSelected()">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <br>
                                <button class="btn btn-outline-secondary btn-sm" onclick="removeFromSelected()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small font-weight-bold">Selected Sessions</label>
                            <div class="border rounded p-2" style="height: 150px; overflow-y: auto; background-color: #e8f5e8;">
                                <div id="selectedSessions"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-primary btn-sm me-2" onclick="generateReport()">
                                    <i class="fas fa-chart-bar me-1"></i>Generate Report
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="clearSelection()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                            <small class="text-muted" id="selectionInfo">No sessions selected</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Mode Toggle -->
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-end">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="monthlyViewMode" id="monthlyIndividualView" value="individual">
                <label class="btn btn-outline-primary btn-sm" for="monthlyIndividualView">
                    <i class="fas fa-list"></i> Individual
                </label>
                <input type="radio" class="btn-check" name="monthlyViewMode" id="monthlyGroupedView" value="grouped" checked>
                <label class="btn btn-outline-primary btn-sm" for="monthlyGroupedView">
                    <i class="fas fa-layer-group"></i> Grouped
                </label>
            </div>
        </div>
    </div>

    <!-- Compact Report Controls -->
    <div class="row mb-3" id="reportControls" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-left-success">
                <div class="card-body py-2">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small font-weight-bold">Period</label>
                            <select class="form-select form-select-sm" id="reportPeriod">
                                <option value="current_month">Current Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="customDateRange" style="display: none;">
                            <label class="form-label small font-weight-bold">Date Range</label>
                            <div class="d-flex gap-1">
                                <input type="date" class="form-control form-control-sm" id="startDate">
                                <input type="date" class="form-control form-control-sm" id="endDate">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small font-weight-bold">Format</label>
                            <select class="form-select form-select-sm" id="reportFormat">
                                <option value="executive">Executive Summary</option>
                                <option value="detailed">Detailed Analysis</option>
                                <option value="technical">Technical Deep Dive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success btn-sm w-100" onclick="updateReport()">
                                <i class="fas fa-refresh me-1"></i>Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Executive Summary Cards -->
    <div class="summary-cards-row mb-3" id="summaryCards" style="display: none;">
        <div class="summary-card-col">
            <div class="card border-left-primary shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Emails
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="totalEmailsProcessed">9,000</div>
                            <div class="text-xs text-success">
                                <i class="fas fa-arrow-up"></i> <span id="emailsGrowth">15%</span> vs last period
                            </div>
                        </div>
                        <div class="text-primary ms-2">
                            <i class="fas fa-envelope fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card-col">
            <div class="card border-left-danger shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Security Incidents
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="securityIncidents">2,260</div>
                            <div class="text-xs text-warning">
                                <i class="fas fa-exclamation-triangle"></i> <span id="incidentsRate">25.1%</span> rate
                            </div>
                        </div>
                        <div class="text-danger ms-2">
                            <i class="fas fa-shield-alt fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card-col">
            <div class="card border-left-success shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Cases Resolved
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="casesResolved">0</div>
                            <div class="text-xs text-success">
                                <i class="fas fa-check"></i> <span id="resolutionRate">0.0%</span> rate
                            </div>
                        </div>
                        <div class="text-success ms-2">
                            <i class="fas fa-check-circle fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card-col">
            <div class="card border-left-warning shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Avg Response Time
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="avgResponseTime">2.5h</div>
                            <div class="text-xs text-info">
                                <i class="fas fa-clock"></i> <span id="responseImprovement">8%</span> better
                            </div>
                        </div>
                        <div class="text-warning ms-2">
                            <i class="fas fa-stopwatch fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Main Charts Section -->
    <div class="row mb-3" id="mainCharts" style="display: none;">
        <!-- Risk Trend Analysis -->
        <div class="col-xl-8 col-lg-7 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Security Risk Trends</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="riskTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Distribution -->
        <div class="col-xl-4 col-lg-5 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Risk Level Distribution</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="riskDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Secondary Charts -->
    <div class="row mb-3" id="secondaryCharts" style="display: none;">
        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Email Volume by Department</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="departmentVolumeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Top Threat Domains</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="threatDomainsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Audit Section -->
    <div class="row mb-4" id="auditSection" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>System Security Audit</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Audit Summary Cards -->
                        <div class="col-md-3">
                            <div class="card text-center bg-primary text-white">
                                <div class="card-body">
                                    <h4 id="totalAuditActions">1,245</h4>
                                    <small>Total Actions Logged</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center bg-warning text-white">
                                <div class="card-body">
                                    <h4 id="securityEvents">23</h4>
                                    <small>Security Events</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center bg-success text-white">
                                <div class="card-body">
                                    <h4 id="configChanges">8</h4>
                                    <small>Config Changes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center bg-danger text-white">
                                <div class="card-body">
                                    <h4 id="criticalAlerts">2</h4>
                                    <small>Critical Alerts</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Timeline -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <h6>Audit Activity Timeline</h6>
                            <canvas id="auditTimelineChart" height="200"></canvas>
                        </div>
                        <div class="col-md-4">
                            <h6>Recent Critical Events</h6>
                            <div class="list-group">
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Config Change</h6>
                                        <small>2 hours ago</small>
                                    </div>
                                    <p class="mb-1">ML threshold updated</p>
                                    <small>User: admin</small>
                                </div>
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Data Export</h6>
                                        <small>5 hours ago</small>
                                    </div>
                                    <p class="mb-1">Case data exported (CSV)</p>
                                    <small>User: analyst</small>
                                </div>
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Large Upload</h6>
                                        <small>1 day ago</small>
                                    </div>
                                    <p class="mb-1">15,000 records processed</p>
                                    <small>File: Q4_emails.csv</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Data Analysis Section -->
    <div class="row mb-4" id="enhancedDataSection" style="display: none;">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Time-based Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="timeAnalysisChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Communication Patterns</h5>
                </div>
                <div class="card-body">
                    <canvas id="communicationChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Sender Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="senderAnalysisChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Content Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="contentAnalysisChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Section -->
    <div class="row mb-4" id="detailedAnalytics" style="display: none;">
        <!-- ML Performance Metrics -->
        <div class="col-xl-4 col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">ML Performance</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="mlPerformanceChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col">
                                <div class="h5 mb-0" id="mlAccuracy">95.2%</div>
                                <small class="text-muted">Accuracy</small>
                            </div>
                            <div class="col">
                                <div class="h5 mb-0" id="mlPrecision">92.8%</div>
                                <small class="text-muted">Precision</small>
                            </div>
                            <div class="col">
                                <div class="h5 mb-0" id="mlRecall">89.4%</div>
                                <small class="text-muted">Recall</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Time Metrics -->
        <div class="col-xl-4 col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Response Time Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="responseTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Effectiveness -->
        <div class="col-xl-4 col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Policy Effectiveness</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="policyEffectivenessChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Risks Table -->
    <div class="row mb-4" id="topRisksSection" style="display: none;">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-exclamation-triangle"></i> Top Security Risks This Period
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="topRisksTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Risk Category</th>
                                    <th>Incident Count</th>
                                    <th>Avg Risk Score</th>
                                    <th>Top Sender Domain</th>
                                    <th>Resolution Rate</th>
                                    <th>Trend</th>
                                    <th>Action Required</th>
                                </tr>
                            </thead>
                            <tbody id="topRisksTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Recommendations -->
    <div class="row mb-4" id="recommendationsSection" style="display: none;">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-lightbulb"></i> Key Recommendations for Next Period
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Security Improvements</h6>
                            <ul id="securityRecommendations" class="list-unstyled">
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Process Optimizations</h6>
                            <ul id="processRecommendations" class="list-unstyled">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Grouped Data Table -->
<div class="row mb-4" id="monthlyGroupedTableContainer" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-layer-group"></i> Grouped Email Analysis
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered monthly-grouped-container">
                        <thead>
                            <tr>
                                <th>Details</th>
                                <th>Sender</th>
                                <th>Subject</th>
                                <th>Recipients</th>
                                <th>Risk Level</th>
                                <th>Avg Score</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Grouped data will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Individual Email Table (placeholder for individual view) -->
<div class="row mb-4" id="monthlyIndividualTableContainer" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list"></i> Individual Email Analysis
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered monthly-individual-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Sender</th>
                                <th>Subject</th>
                                <th>Date</th>
                                <th>Recipients</th>
                                <th>Risk Level</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Individual email data will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chart-container {
    position: relative;
}

.session-item {
    padding: 8px 12px;
    margin: 4px 0;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.session-item:hover {
    background: #e9ecef;
    border-color: #007bff;
}

.session-item.selected {
    background: #007bff;
    color: white;
    border-color: #0056b3;
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
}

.recommendation-item {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.recommendation-item:last-child {
    border-bottom: none;
}

.trend-up {
    color: #dc3545;
}

.trend-down {
    color: #28a745;
}

.trend-stable {
    color: #6c757d;
}

.group-details-row td div {
    background-color: #f8f9fa; /* Light background for details */
}

.grouped-row:hover .group-details-row {
    background-color: #e9ecef; /* Hover effect for details row */
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Monthly Report Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Load sample sessions
    loadAvailableSessions();

    // Initialize event listeners
    document.getElementById('reportFormat').addEventListener('change', handleFormatChange);
    document.getElementById('reportPeriod').addEventListener('change', handlePeriodChange);

    // Auto-show controls and cards for demo with data population
    setTimeout(() => {
        document.getElementById('reportControls').style.display = 'block';
        document.getElementById('summaryCards').style.display = 'block';
        document.getElementById('mainCharts').style.display = 'block';
        document.getElementById('secondaryCharts').style.display = 'block';

        // Populate all data fields immediately
        populateAllData();
        showReportSections('executive');
        initializeCharts();
    }, 500);
});

function loadAvailableSessions() {
    const availableDiv = document.getElementById('availableSessions');
    if (!availableDiv) return;

    // Load real sessions from API
    fetch('/api/monthly-report/sessions')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                availableDiv.innerHTML = '<div class="text-danger">Error loading sessions: ' + data.error + '</div>';
                return;
            }

            const sessions = data.sessions || [];
            if (sessions.length === 0) {
                availableDiv.innerHTML = '<div class="text-muted">No sessions available. Please upload and process some email data first.</div>';
                return;
            }

            availableDiv.innerHTML = sessions.map(session => 
                `<div class="session-item" onclick="selectSession('${session.id}', this)" data-session-id="${session.id}">
                    <strong>${session.name}</strong><br>
                    <small class="text-muted">${session.date} • ${session.records.toLocaleString()} records</small>
                    ${session.status === 'completed' ? '<span class="badge bg-success ms-2">Complete</span>' : 
                      session.status === 'processing' ? '<span class="badge bg-warning">Processing</span>' : 
                      '<span class="badge bg-secondary">' + session.status + '</span>'}
                    ${session.critical_cases > 0 ? '<br><small class="text-danger">' + session.critical_cases + ' critical cases</small>' : ''}
                </div>`
            ).join('');
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
            availableDiv.innerHTML = '<div class="text-danger">Error loading sessions</div>';
        });
}

function selectSession(sessionId, element) {
    if (element.classList.contains('selected')) {
        element.classList.remove('selected');
    } else {
        element.classList.add('selected');
    }
    updateSelectionInfo();
}

function updateSelectionInfo() {
    const selectedCount = document.querySelectorAll('.session-item.selected').length;
    const infoElement = document.getElementById('selectionInfo');
    if (infoElement) {
        infoElement.textContent = selectedCount > 0 ? 
            `${selectedCount} session${selectedCount > 1 ? 's' : ''} selected` : 
            'No sessions selected';
    }
}

function generateReport() {
    const selectedSessions = document.querySelectorAll('.session-item.selected');
    if (selectedSessions.length === 0) {
        alert('Please select at least one session to generate a report.');
        return;
    }

    // Get selected session IDs
    const sessionIds = Array.from(selectedSessions).map(session => 
        session.getAttribute('data-session-id')
    );

    // Move selected sessions to the selected panel
    const selectedDiv = document.getElementById('selectedSessions');
    selectedDiv.innerHTML = '';

    selectedSessions.forEach(session => {
        const clonedSession = session.cloneNode(true);
        clonedSession.onclick = () => removeFromSelected(clonedSession);
        selectedDiv.appendChild(clonedSession);
    });

    // Show loading
    showLoading('Generating report from your data...');

    // Generate report using real API
    const reportConfig = {
        session_ids: sessionIds,
        period: document.getElementById('reportPeriod').value,
        format: document.getElementById('reportFormat').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value
    };

    fetch('/api/monthly-report/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportConfig)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        // Hide loading
        hideLoading();

        // Store report data globally
        window.reportData = data;

        // Show report sections
        document.getElementById('reportControls').style.display = 'block';
        document.getElementById('summaryCards').style.display = 'block';
        document.getElementById('mainCharts').style.display = 'block';
        document.getElementById('secondaryCharts').style.display = 'block';

        // Populate with real data
        populateRealData(data);

        // Show sections based on current format
        const format = document.getElementById('reportFormat').value;
        showReportSections(format);

        // Initialize charts with real data
        setTimeout(() => initializeChartsWithData(data), 100);

        updateSelectionInfo();
        showNotification('Report generated successfully with your data!', 'success');
    })
    .catch(error => {
        console.error('Error generating report:', error);
        hideLoading();
        showNotification('Error generating report: ' + error.message, 'error');
    });
}

function removeFromSelected(element) {
    element.remove();
    updateSelectionInfo();
}

function clearSelection() {
    document.querySelectorAll('.session-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    document.getElementById('selectedSessions').innerHTML = '';
    updateSelectionInfo();
}

function handleFormatChange() {
    const format = document.getElementById('reportFormat').value;
    showReportSections(format);
}

function showReportSections(format) {
    // Hide all optional sections first
    const sections = ['detailedAnalytics', 'topRisksSection', 'recommendationsSection', 'auditSection', 'enhancedDataSection', 'monthlyGroupedTableContainer', 'monthlyIndividualTableContainer'];
    sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) section.style.display = 'none';
    });

    // Show sections based on format
    switch(format) {
        case 'executive':
            // Executive shows only summary cards and main charts
            break;
        case 'detailed':
            // Detailed shows enhanced data and analytics
            document.getElementById('detailedAnalytics').style.display = 'block';
            document.getElementById('topRisksSection').style.display = 'block';
            document.getElementById('enhancedDataSection').style.display = 'block';
            break;
        case 'technical':
            // Technical shows everything including audit and recommendations
            document.getElementById('detailedAnalytics').style.display = 'block';
            document.getElementById('topRisksSection').style.display = 'block';
            document.getElementById('recommendationsSection').style.display = 'block';
            document.getElementById('auditSection').style.display = 'block';
            document.getElementById('enhancedDataSection').style.display = 'block';
            break;
    }

    // Initialize charts for visible sections
    initializeCharts();
}

function handlePeriodChange() {
    const period = document.getElementById('reportPeriod').value;
    const customRange = document.getElementById('customDateRange');

    if (period === 'custom') {
        customRange.style.display = 'block';
    } else {
        customRange.style.display = 'none';
    }
}

function updateReport() {
    const format = document.getElementById('reportFormat').value;
    showReportSections(format);

    // Ensure data is populated
    populateAllData();

    // Re-initialize charts for new format
    setTimeout(() => initializeCharts(), 100);
}

function populateAllData() {
    // This is the fallback function for demo data
    if (window.reportData) {
        populateRealData(window.reportData);
        return;
    }
    
    // Fallback demo data
    document.getElementById('totalEmailsProcessed').textContent = '0';
    document.getElementById('securityIncidents').textContent = '0';
    document.getElementById('casesResolved').textContent = '0';
    document.getElementById('avgResponseTime').textContent = 'N/A';
    document.getElementById('emailsGrowth').textContent = '0%';
    document.getElementById('incidentsRate').textContent = '0%';
    document.getElementById('resolutionRate').textContent = '0%';
    document.getElementById('responseImprovement').textContent = '0%';
}

function populateRealData(data) {
    // Populate summary cards with real data
    const summary = data.summary;
    
    // Set main numbers with real data
    document.getElementById('totalEmailsProcessed').textContent = summary.total_emails.toLocaleString();
    document.getElementById('securityIncidents').textContent = summary.security_incidents.toLocaleString();
    document.getElementById('casesResolved').textContent = summary.cases_resolved.toLocaleString();
    document.getElementById('avgResponseTime').textContent = summary.avg_response_time;

    // Set rate indicators with real data
    document.getElementById('emailsGrowth').textContent = 'Current period';
    document.getElementById('incidentsRate').textContent = summary.incidents_rate + '%';
    document.getElementById('resolutionRate').textContent = summary.resolution_rate + '%';
    document.getElementById('responseImprovement').textContent = 'Calculated';
}

function showLoading(message) {
    // Create or show loading indicator
    let loadingDiv = document.getElementById('loadingIndicator');
    if (!loadingDiv) {
        loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.className = 'alert alert-info text-center';
        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i><span id="loadingMessage"></span>';
        document.querySelector('.container-fluid').insertBefore(loadingDiv, document.querySelector('.container-fluid').firstChild);
    }
    document.getElementById('loadingMessage').textContent = message;
    loadingDiv.style.display = 'block';
}

function hideLoading() {
    const loadingDiv = document.getElementById('loadingIndicator');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}

function showNotification(message, type = 'info') {
    // Create notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function animateNumbers() {
    // Just update the display immediately - no animation for faster loading
    populateAllData();
}

function initializeChartsWithData(data) {
    // Initialize charts with real data
    initializeRiskTrendChart(data);
    initializeRiskDistributionChart(data);
    initializeDepartmentVolumeChart(data);
    initializeThreatDomainsChart(data);
}

function initializeRiskTrendChart(data) {
    const ctx = document.getElementById('riskTrendChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }

    ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.timeline_data.labels,
            datasets: [{
                label: 'Email Volume',
                data: data.timeline_data.data,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializeRiskDistributionChart(data) {
    const ctx = document.getElementById('riskDistributionChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }

    ctx.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data.risk_distribution),
            datasets: [{
                data: Object.values(data.risk_distribution),
                backgroundColor: ['#e74a3b', '#fd7e14', '#f6c23e', '#1cc88a'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function initializeDepartmentVolumeChart(data) {
    const ctx = document.getElementById('departmentVolumeChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }

    const departments = Object.keys(data.department_volume);
    const volumes = Object.values(data.department_volume);

    ctx.chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: departments,
            datasets: [{
                label: 'Email Volume',
                data: volumes,
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializeThreatDomainsChart(data) {
    const ctx = document.getElementById('threatDomainsChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }

    ctx.chart = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
            labels: data.top_domains.labels,
            datasets: [{
                label: 'Email Count',
                data: data.top_domains.data,
                backgroundColor: '#36b9cc',
                borderColor: '#36b9cc',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializeCharts() {
    // Fallback function for demo charts with dummy data
    // Destroy existing charts first to prevent duplication
    const riskTrendCtx = document.getElementById('riskTrendChart');
    if (riskTrendCtx && riskTrendCtx.chart) {
        riskTrendCtx.chart.destroy();
    }

    const riskDistCtx = document.getElementById('riskDistributionChart');
    if (riskDistCtx && riskDistCtx.chart) {
        riskDistCtx.chart.destroy();
    }

    const deptVolumeCtx = document.getElementById('departmentVolumeChart');
    if (deptVolumeCtx && deptVolumeCtx.chart) {
        deptVolumeCtx.chart.destroy();
    }

    const threatDomainsCtx = document.getElementById('threatDomainsChart');
    if (threatDomainsCtx && threatDomainsCtx.chart) {
        threatDomainsCtx.chart.destroy();
    }

    // Destroy enhanced charts
    const auditTimelineCtx = document.getElementById('auditTimelineChart');
    if (auditTimelineCtx && auditTimelineCtx.chart) {
        auditTimelineCtx.chart.destroy();
    }

    const timeAnalysisCtx = document.getElementById('timeAnalysisChart');
    if (timeAnalysisCtx && timeAnalysisCtx.chart) {
        timeAnalysisCtx.chart.destroy();
    }

    const communicationCtx = document.getElementById('communicationChart');
    if (communicationCtx && communicationCtx.chart) {
        communicationCtx.chart.destroy();
    }

    const senderAnalysisCtx = document.getElementById('senderAnalysisChart');
    if (senderAnalysisCtx && senderAnalysisCtx.chart) {
        senderAnalysisCtx.chart.destroy();
    }

    const contentAnalysisCtx = document.getElementById('contentAnalysisChart');
    if (contentAnalysisCtx && contentAnalysisCtx.chart) {
        contentAnalysisCtx.chart.destroy();
    }

    // Initialize Risk Trend Chart
    if (riskTrendCtx) {
        riskTrendCtx.chart = new Chart(riskTrendCtx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'High Risk',
                    data: [350, 280, 450, 320],
                    borderColor: '#e74a3b',
                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Medium Risk', 
                    data: [650, 720, 580, 690],
                    borderColor: '#f6c23e',
                    backgroundColor: 'rgba(246, 194, 62, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Low Risk',
                    data: [1200, 1150, 1300, 1180],
                    borderColor: '#1cc88a', 
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Initialize Risk Distribution Chart
    if (riskDistCtx) {
        riskDistCtx.chart = new Chart(riskDistCtx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [124, 2136, 4820, 1920],
                    backgroundColor: ['#e74a3b', '#fd7e14', '#f6c23e', '#1cc88a'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Initialize Department Volume Chart
    if (deptVolumeCtx) {
        deptVolumeCtx.chart = new Chart(deptVolumeCtx, {
            type: 'bar',
            data: {
                labels: ['Finance', 'HR', 'IT', 'Sales', 'Marketing'],
                datasets: [{
                    label: 'Email Volume',
                    data: [2400, 1800, 3200, 2100, 1500],
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Initialize Threat Domains Chart
    if (threatDomainsCtx) {
        threatDomainsCtx.chart = new Chart(threatDomainsCtx, {
            type: 'horizontalBar',
            data: {
                labels: ['suspicious-domain.com', 'phishing-site.org', 'malware-host.net', 'spam-sender.biz', 'fake-bank.co'],
                datasets: [{
                    label: 'Threat Count',
                    data: [45, 38, 32, 28, 24],
                    backgroundColor: '#e74a3b',
                    borderColor: '#c0392b',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Initialize Enhanced Charts
    initializeEnhancedCharts();
}

function initializeEnhancedCharts() {
    // Initialize Audit Timeline Chart
    const auditTimelineCtx = document.getElementById('auditTimelineChart');
    if (auditTimelineCtx) {
        auditTimelineCtx.chart = new Chart(auditTimelineCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                datasets: [{
                    label: 'System Activity',
                    data: [12, 8, 25, 45, 38, 15],
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Security Events',
                    data: [2, 1, 5, 8, 6, 3],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    // Initialize Time Analysis Chart
    const timeAnalysisCtx = document.getElementById('timeAnalysisChart');
    if (timeAnalysisCtx) {
        timeAnalysisCtx.chart = new Chart(timeAnalysisCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Email Volume',
                    data: [1200, 1500, 1800, 1600, 1400, 400, 300],
                    backgroundColor: '#4e73df'
                }, {
                    label: 'Risk Incidents',
                    data: [120, 180, 220, 190, 150, 45, 35],
                    backgroundColor: '#e74a3b'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    // Initialize Communication Chart
    const communicationCtx = document.getElementById('communicationChart');
    if (communicationCtx) {
        communicationCtx.chart = new Chart(communicationCtx, {
            type: 'radar',
            data: {
                labels: ['Internal', 'External', 'Personal', 'Automated', 'Suspicious'],
                datasets: [{
                    label: 'Communication Patterns',
                    data: [85, 45, 25, 65, 15],
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.2)',
                    pointBackgroundColor: '#1cc88a'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    // Initialize Sender Analysis Chart
    const senderAnalysisCtx = document.getElementById('senderAnalysisChart');
    if (senderAnalysisCtx) {
        senderAnalysisCtx.chart = new Chart(senderAnalysisCtx, {
            type: 'pie',
            data: {
                labels: ['Corporate', 'External', 'Personal', 'Unknown'],
                datasets: [{
                    data: [65, 20, 10, 5],
                    backgroundColor: ['#4e73df', '#f6c23e', '#1cc88a', '#e74a3b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Initialize Content Analysis Chart
    const contentAnalysisCtx = document.getElementById('contentAnalysisChart');
    if (contentAnalysisCtx) {
        contentAnalysisCtx.chart = new Chart(contentAnalysisCtx, {
            type: 'doughnut',
            data: {
                labels: ['Business', 'Personal', 'Marketing', 'Security Risk'],
                datasets: [{
                    data: [45, 25, 20, 10],
                    backgroundColor: ['#36b9cc', '#1cc88a', '#f6c23e', '#e74a3b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

function refreshDashboard() {
    location.reload();
}

function exportMonthlyReport() {
    alert('PDF export functionality would be implemented here');
}

function exportExcelReport() {
    alert('Excel export functionality would be implemented here');
}

// Monthly Report Grouping JavaScript
let monthlyGroupedData = [];
let currentMonthlyViewMode = 'grouped';

// Initialize monthly report page
document.addEventListener('DOMContentLoaded', function() {
    initializeMonthlyViewToggle();
    // Start with grouped view by default
    if (document.getElementById('monthlyGroupedView').checked) {
        switchToMonthlyGroupedView();
    }
});

// Initialize view mode toggle for monthly reports
function initializeMonthlyViewToggle() {
    const individualViewRadio = document.getElementById('monthlyIndividualView');
    const groupedViewRadio = document.getElementById('monthlyGroupedView');

    if (individualViewRadio) {
        individualViewRadio.addEventListener('change', function() {
            if (this.checked) {
                currentMonthlyViewMode = 'individual';
                switchToMonthlyIndividualView();
            }
        });
    }

    if (groupedViewRadio) {
        groupedViewRadio.addEventListener('change', function() {
            if (this.checked) {
                currentMonthlyViewMode = 'grouped';
                switchToMonthlyGroupedView();
            }
        });
    }
}

// Switch to individual view for monthly reports
function switchToMonthlyIndividualView() {
    // Hide grouped containers and show individual tables
    const groupedContainers = document.querySelectorAll('.monthly-grouped-container');
    const individualTables = document.querySelectorAll('.monthly-individual-table');
    const monthlyGroupedTableContainer = document.getElementById('monthlyGroupedTableContainer');
    const monthlyIndividualTableContainer = document.getElementById('monthlyIndividualTableContainer');

    if (groupedContainers) groupedContainers.forEach(container => container.style.display = 'none');
    if (individualTables) individualTables.forEach(table => table.style.display = 'table');
    if (monthlyGroupedTableContainer) monthlyGroupedTableContainer.style.display = 'none';
    if (monthlyIndividualTableContainer) monthlyIndividualTableContainer.style.display = 'block';
}

// Switch to grouped view for monthly reports
function switchToMonthlyGroupedView() {
    loadMonthlyGroupedData();
    const monthlyGroupedTableContainer = document.getElementById('monthlyGroupedTableContainer');
    const monthlyIndividualTableContainer = document.getElementById('monthlyIndividualTableContainer');

    if (monthlyGroupedTableContainer) monthlyGroupedTableContainer.style.display = 'block';
    if (monthlyIndividualTableContainer) monthlyIndividualTableContainer.style.display = 'none';
}

// Load grouped monthly data
function loadMonthlyGroupedData() {
    // Get all selected session IDs from the monthly report
    const selectedSessions = Array.from(document.querySelectorAll('#selectedSessions .session-item')).map(item => 
        item.getAttribute('data-session-id')
    );

    if (!selectedSessions.length) {
        return;
    }

    // Fetch grouped data for all selected sessions
    Promise.all(selectedSessions.map(sessionId => 
        fetch(`/api/grouped-cases/${sessionId}`)
            .then(response => response.json())
    ))
    .then(responses => {
        // Combine all grouped data
        monthlyGroupedData = responses.reduce((combined, response) => {
            if (response.grouped_cases) {
                return combined.concat(response.grouped_cases);
            }
            return combined;
        }, []);

        renderMonthlyGroupedData();
    })
    .catch(error => {
        console.error('Error loading monthly grouped data:', error);
    });
}

// Render monthly grouped data
function renderMonthlyGroupedData() {
    // Hide individual tables and show grouped containers
    const individualTables = document.querySelectorAll('.monthly-individual-table');
    const groupedContainers = document.querySelectorAll('.monthly-grouped-container');

    if (individualTables) individualTables.forEach(table => table.style.display = 'none');
    if (groupedContainers) groupedContainers.forEach(container => {
        container.style.display = 'block';
        const tableBody = container.querySelector('tbody');
        if (tableBody) {
            tableBody.innerHTML = '';

            // Render grouped data
            monthlyGroupedData.forEach((group, index) => {
                const groupRow = createMonthlyGroupRow(group, index);
                tableBody.appendChild(groupRow);
            });
        }
    });
}

// Create monthly group row
function createMonthlyGroupRow(group, index) {
    const row = document.createElement('tr');
    row.className = 'grouped-row';

    const riskBadgeClass = {
        'Critical': 'bg-danger',
        'High': 'bg-warning text-dark',
        'Medium': 'bg-info', 
        'Low': 'bg-success'
    }[group.risk_level] || 'bg-secondary';

    row.innerHTML = `
        <td>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleMonthlyGroupDetails(${index})">
                <i class="fas fa-chevron-right" id="monthly-toggle-${index}"></i>
            </button>
        </td>
        <td>
            <strong>${group.sender || 'Unknown'}</strong>
            ${group.is_leaver ? '<span class="badge bg-warning text-dark ms-2">Leaver</span>' : ''}
        </td>
        <td>${(group.subject || 'No Subject').substring(0, 50)}${(group.subject || '').length > 50 ? '...' : ''}</td>
        <td>
            <span class="badge bg-info">${group.record_count}</span>
            <small class="text-muted ms-2">${group.recipients.length} unique</small>
        </td>
        <td><span class="badge ${riskBadgeClass}">${group.risk_level}</span></td>
        <td><strong>${group.avg_risk_score}</strong></td>
        <td><span class="badge bg-primary">${group.case_status}</span></td>
        <td><small>${group.time_display}</small></td>
        <td>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="viewMonthlyGroupDetails(${index})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-warning" onclick="flagMonthlyGroup(${index})">
                    <i class="fas fa-flag"></i>
                </button>
            </div>
        </td>
    `;

    // Add details row (initially hidden)
    const detailsRow = document.createElement('tr');
    detailsRow.className = 'group-details-row';
    detailsRow.id = `monthly-details-${index}`;
    detailsRow.style.display = 'none';
    detailsRow.innerHTML = `
        <td colspan="9">
            <div class="border-start border-primary border-3 ps-3 py-2">
                <h6>Recipients in this group (${group.recipients.length}):</h6>
                <div class="row">
                    ${group.recipients.map(recipient => `
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                <div>
                                    <strong>${recipient.recipient || 'Unknown'}</strong>
                                    <br><small class="text-muted">${recipient.recipient_domain || ''}</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewMonthlyCase('${recipient.record_id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </td>
    `;

    row.parentNode.insertBefore(detailsRow, row.nextSibling);
    return row;
}

// Toggle monthly group details
function toggleMonthlyGroupDetails(index) {
    const detailsRow = document.getElementById(`monthly-details-${index}`);
    const toggleIcon = document.getElementById(`monthly-toggle-${index}`);

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        toggleIcon.className = 'fas fa-chevron-down';
    } else {
        detailsRow.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-right';
    }
}

// View monthly case details
function viewMonthlyCase(recordId) {
    // Find the session containing this record
    const selectedSessions = Array.from(document.querySelectorAll('#selectedSessions .session-item')).map(item => 
        item.getAttribute('data-session-id')
    );

    if (selectedSessions.length > 0) {
        showCaseDetails(selectedSessions[0], recordId); // Assuming showCaseDetails is globally available
    }
}

// Flag monthly group
function flagMonthlyGroup(index) {
    const group = monthlyGroupedData[index];
    if (group) {
        // Flag all recipients in the group
        group.recipients.forEach(recipient => {
            flagCase(recipient.record_id); // Assuming flagCase is globally available
        });
        showSuccess(`Flagged all ${group.recipients.length} recipients in group`);
    }
}

// Placeholder for showCaseDetails if it's not globally available
function showCaseDetails(sessionId, recordId) {
    console.log(`Showing details for case ${recordId} from session ${sessionId}`);
    // Implement logic to display case details, possibly in a modal or dedicated section
}

// Placeholder for flagCase if it's not globally available
function flagCase(recordId) {
    console.log(`Flagging case ${recordId}`);
    // Implement logic to flag the case
}

// Utility functions
function showSuccess(message) {
    showNotification(message, 'success');
}

function showError(message) {
    showNotification(message, 'danger');
}

// Placeholder for showNotification if it's not globally available
function showNotification(message, type) {
    console.log(`Notification [${type}]: ${message}`);
    // Implement actual notification display logic (e.g., using toastr or a custom notification component)
}
</script>
{% endblock %}