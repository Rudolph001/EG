
{% extends "base.html" %}

{% block title %}Monthly Report Dashboard - Email Guardian{% endblock %}

{% block extra_css %}
<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .border-left-primary {
        border-left: 0.25rem solid #007bff !important;
    }
    
    .border-left-danger {
        border-left: 0.25rem solid #dc3545 !important;
    }
    
    .border-left-success {
        border-left: 0.25rem solid #28a745 !important;
    }
    
    .border-left-warning {
        border-left: 0.25rem solid #ffc107 !important;
    }
    
    .opacity-25 {
        opacity: 0.25;
    }
    
    .chart-container {
        position: relative;
    }
    
    .card-header.bg-light {
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6;
    }
    
    .text-xs {
        font-size: 0.75rem;
    }
    
    .font-weight-bold {
        font-weight: 700 !important;
    }
    
    .text-gray-800 {
        color: #5a5c69 !important;
    }
    
    .shadow-sm {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
    }
    
    .card {
        transition: transform 0.2s ease-in-out;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-select-sm {
        padding: 0.25rem 2rem 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-control-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .gap-1 {
        gap: 0.25rem;
    }
    
    .gap-2 {
        gap: 0.5rem;
    }
    
    /* Compact spacing */
    .mb-3 {
        margin-bottom: 1rem !important;
    }
    
    .py-2 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }
    
    .py-3 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
    }
    
    .p-3 {
        padding: 1rem !important;
    }
    
    .h3 {
        font-size: 1.75rem;
    }
    
    .h4 {
        font-size: 1.5rem;
    }
    
    .h6 {
        font-size: 1rem;
    }
    
    /* Fix column layout for summary cards */
    .summary-cards-row {
        display: flex !important;
        flex-wrap: wrap !important;
        margin: 0 -8px;
    }
    
    .summary-card-col {
        flex: 0 0 25% !important;
        max-width: 25% !important;
        padding: 0 8px !important;
        margin-bottom: 16px !important;
    }
    
    @media (max-width: 992px) {
        .summary-card-col {
            flex: 0 0 50% !important;
            max-width: 50% !important;
        }
    }
    
    @media (max-width: 576px) {
        .summary-card-col {
            flex: 0 0 100% !important;
            max-width: 100% !important;
        }
    }
    
    .card-compact {
        height: 100%;
        min-height: 120px;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Upload</a></li>
<li class="breadcrumb-item active">Monthly Report</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Compact Page Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm border-0 bg-gradient-primary text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-1 font-weight-bold">
                                <i class="fas fa-shield-alt me-2"></i>Monthly Email Security Report
                            </h1>
                            <p class="mb-0 opacity-75">Comprehensive security analysis dashboard</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light btn-sm" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportMonthlyReport()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="btn btn-info btn-sm" onclick="exportExcelReport()">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Session Selection Panel -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0 font-weight-bold text-primary">
                        <i class="fas fa-database me-1"></i>Data Sources Selection
                    </h6>
                </div>
                <div class="card-body py-3">
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label small font-weight-bold">Available Sessions</label>
                            <div class="border rounded p-2" style="height: 150px; overflow-y: auto; background-color: #f8f9fa;">
                                <div id="availableSessions"></div>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <button class="btn btn-outline-primary btn-sm mb-2" onclick="moveToSelected()">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <br>
                                <button class="btn btn-outline-secondary btn-sm" onclick="removeFromSelected()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small font-weight-bold">Selected Sessions</label>
                            <div class="border rounded p-2" style="height: 150px; overflow-y: auto; background-color: #e8f5e8;">
                                <div id="selectedSessions"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-primary btn-sm me-2" onclick="generateReport()">
                                    <i class="fas fa-chart-bar me-1"></i>Generate Report
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="clearSelection()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                            <small class="text-muted" id="selectionInfo">No sessions selected</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Report Controls -->
    <div class="row mb-3" id="reportControls" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-left-success">
                <div class="card-body py-2">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small font-weight-bold">Period</label>
                            <select class="form-select form-select-sm" id="reportPeriod">
                                <option value="current_month">Current Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="customDateRange" style="display: none;">
                            <label class="form-label small font-weight-bold">Date Range</label>
                            <div class="d-flex gap-1">
                                <input type="date" class="form-control form-control-sm" id="startDate">
                                <input type="date" class="form-control form-control-sm" id="endDate">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small font-weight-bold">Format</label>
                            <select class="form-select form-select-sm" id="reportFormat">
                                <option value="executive">Executive Summary</option>
                                <option value="detailed">Detailed Analysis</option>
                                <option value="technical">Technical Deep Dive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success btn-sm w-100" onclick="updateReport()">
                                <i class="fas fa-refresh me-1"></i>Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Executive Summary Cards -->
    <div class="summary-cards-row mb-3" id="summaryCards" style="display: none;">
        <div class="summary-card-col">
            <div class="card border-left-primary shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Emails
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="totalEmailsProcessed">9,000</div>
                            <div class="text-xs text-success">
                                <i class="fas fa-arrow-up"></i> <span id="emailsGrowth">15%</span> vs last period
                            </div>
                        </div>
                        <div class="text-primary ms-2">
                            <i class="fas fa-envelope fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card-col">
            <div class="card border-left-danger shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Security Incidents
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="securityIncidents">2,260</div>
                            <div class="text-xs text-warning">
                                <i class="fas fa-exclamation-triangle"></i> <span id="incidentsRate">25.1%</span> rate
                            </div>
                        </div>
                        <div class="text-danger ms-2">
                            <i class="fas fa-shield-alt fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card-col">
            <div class="card border-left-success shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Cases Resolved
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="casesResolved">0</div>
                            <div class="text-xs text-success">
                                <i class="fas fa-check"></i> <span id="resolutionRate">0.0%</span> rate
                            </div>
                        </div>
                        <div class="text-success ms-2">
                            <i class="fas fa-check-circle fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-card-col">
            <div class="card border-left-warning shadow-sm card-compact">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center h-100">
                        <div class="flex-grow-1">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Avg Response Time
                            </div>
                            <div class="h4 mb-1 font-weight-bold text-gray-800" id="avgResponseTime">2.5h</div>
                            <div class="text-xs text-info">
                                <i class="fas fa-clock"></i> <span id="responseImprovement">8%</span> better
                            </div>
                        </div>
                        <div class="text-warning ms-2">
                            <i class="fas fa-stopwatch fa-2x opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Main Charts Section -->
    <div class="row mb-3" id="mainCharts" style="display: none;">
        <!-- Risk Trend Analysis -->
        <div class="col-xl-8 col-lg-7 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Security Risk Trends</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="riskTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Distribution -->
        <div class="col-xl-4 col-lg-5 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Risk Level Distribution</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="riskDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Secondary Charts -->
    <div class="row mb-3" id="secondaryCharts" style="display: none;">
        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Email Volume by Department</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="departmentVolumeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Top Threat Domains</h6>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="threatDomainsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Audit Section -->
    <div class="row mb-4" id="auditSection" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>System Security Audit</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Audit Summary Cards -->
                        <div class="col-md-3">
                            <div class="card text-center bg-primary text-white">
                                <div class="card-body">
                                    <h4 id="totalAuditActions">1,245</h4>
                                    <small>Total Actions Logged</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center bg-warning text-white">
                                <div class="card-body">
                                    <h4 id="securityEvents">23</h4>
                                    <small>Security Events</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center bg-success text-white">
                                <div class="card-body">
                                    <h4 id="configChanges">8</h4>
                                    <small>Config Changes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center bg-danger text-white">
                                <div class="card-body">
                                    <h4 id="criticalAlerts">2</h4>
                                    <small>Critical Alerts</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audit Timeline -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <h6>Audit Activity Timeline</h6>
                            <canvas id="auditTimelineChart" height="200"></canvas>
                        </div>
                        <div class="col-md-4">
                            <h6>Recent Critical Events</h6>
                            <div class="list-group">
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Config Change</h6>
                                        <small>2 hours ago</small>
                                    </div>
                                    <p class="mb-1">ML threshold updated</p>
                                    <small>User: admin</small>
                                </div>
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Data Export</h6>
                                        <small>5 hours ago</small>
                                    </div>
                                    <p class="mb-1">Case data exported (CSV)</p>
                                    <small>User: analyst</small>
                                </div>
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Large Upload</h6>
                                        <small>1 day ago</small>
                                    </div>
                                    <p class="mb-1">15,000 records processed</p>
                                    <small>File: Q4_emails.csv</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Data Analysis Section -->
    <div class="row mb-4" id="enhancedDataSection" style="display: none;">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Time-based Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="timeAnalysisChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Communication Patterns</h5>
                </div>
                <div class="card-body">
                    <canvas id="communicationChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Sender Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="senderAnalysisChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Content Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="contentAnalysisChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Section -->
    <div class="row mb-4" id="detailedAnalytics" style="display: none;">
        <!-- ML Performance Metrics -->
        <div class="col-xl-4 col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">ML Performance</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="mlPerformanceChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col">
                                <div class="h5 mb-0" id="mlAccuracy">95.2%</div>
                                <small class="text-muted">Accuracy</small>
                            </div>
                            <div class="col">
                                <div class="h5 mb-0" id="mlPrecision">92.8%</div>
                                <small class="text-muted">Precision</small>
                            </div>
                            <div class="col">
                                <div class="h5 mb-0" id="mlRecall">89.4%</div>
                                <small class="text-muted">Recall</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Time Metrics -->
        <div class="col-xl-4 col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Response Time Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="responseTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Effectiveness -->
        <div class="col-xl-4 col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Policy Effectiveness</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="policyEffectivenessChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Risks Table -->
    <div class="row mb-4" id="topRisksSection" style="display: none;">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-exclamation-triangle"></i> Top Security Risks This Period
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="topRisksTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Risk Category</th>
                                    <th>Incident Count</th>
                                    <th>Avg Risk Score</th>
                                    <th>Top Sender Domain</th>
                                    <th>Resolution Rate</th>
                                    <th>Trend</th>
                                    <th>Action Required</th>
                                </tr>
                            </thead>
                            <tbody id="topRisksTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Recommendations -->
    <div class="row mb-4" id="recommendationsSection" style="display: none;">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-lightbulb"></i> Key Recommendations for Next Period
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Security Improvements</h6>
                            <ul id="securityRecommendations" class="list-unstyled">
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Process Optimizations</h6>
                            <ul id="processRecommendations" class="list-unstyled">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chart-container {
    position: relative;
    height: 300px;
}

.session-item {
    padding: 8px 12px;
    margin: 4px 0;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.session-item:hover {
    background: #e9ecef;
    border-color: #007bff;
}

.session-item.selected {
    background: #007bff;
    color: white;
    border-color: #0056b3;
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
}

.recommendation-item {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.recommendation-item:last-child {
    border-bottom: none;
}

.trend-up {
    color: #dc3545;
}

.trend-down {
    color: #28a745;
}

.trend-stable {
    color: #6c757d;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Monthly Report Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Load sample sessions
    loadAvailableSessions();
    
    // Initialize event listeners
    document.getElementById('reportFormat').addEventListener('change', handleFormatChange);
    document.getElementById('reportPeriod').addEventListener('change', handlePeriodChange);
    
    // Auto-show controls and cards for demo with data population
    setTimeout(() => {
        document.getElementById('reportControls').style.display = 'block';
        document.getElementById('summaryCards').style.display = 'block';
        document.getElementById('mainCharts').style.display = 'block';
        document.getElementById('secondaryCharts').style.display = 'block';
        
        // Populate all data fields immediately
        populateAllData();
        showReportSections('executive');
        initializeCharts();
    }, 500);
});

function loadAvailableSessions() {
    const availableDiv = document.getElementById('availableSessions');
    if (!availableDiv) return;
    
    // Sample sessions for demo
    const sampleSessions = [
        { id: 'session1', name: 'Q4_2024_Email_Export.csv', date: '2024-12-15', records: 12500 },
        { id: 'session2', name: 'Nov_2024_Security_Scan.csv', date: '2024-11-20', records: 8900 },
        { id: 'session3', name: 'Oct_2024_Monthly_Data.csv', date: '2024-10-31', records: 9200 }
    ];
    
    availableDiv.innerHTML = sampleSessions.map(session => 
        `<div class="session-item" onclick="selectSession('${session.id}', this)">
            <strong>${session.name}</strong><br>
            <small class="text-muted">${session.date} â€¢ ${session.records.toLocaleString()} records</small>
        </div>`
    ).join('');
}

function selectSession(sessionId, element) {
    if (element.classList.contains('selected')) {
        element.classList.remove('selected');
    } else {
        element.classList.add('selected');
    }
    updateSelectionInfo();
}

function updateSelectionInfo() {
    const selectedCount = document.querySelectorAll('.session-item.selected').length;
    const infoElement = document.getElementById('selectionInfo');
    if (infoElement) {
        infoElement.textContent = selectedCount > 0 ? 
            `${selectedCount} session${selectedCount > 1 ? 's' : ''} selected` : 
            'No sessions selected';
    }
}

function generateReport() {
    const selectedSessions = document.querySelectorAll('.session-item.selected');
    if (selectedSessions.length === 0) {
        alert('Please select at least one session to generate a report.');
        return;
    }
    
    // Move selected sessions to the selected panel
    const selectedDiv = document.getElementById('selectedSessions');
    selectedDiv.innerHTML = '';
    
    selectedSessions.forEach(session => {
        const clonedSession = session.cloneNode(true);
        clonedSession.onclick = () => removeFromSelected(clonedSession);
        selectedDiv.appendChild(clonedSession);
    });
    
    // Show report controls and summary
    document.getElementById('reportControls').style.display = 'block';
    document.getElementById('summaryCards').style.display = 'block';
    document.getElementById('mainCharts').style.display = 'block';
    document.getElementById('secondaryCharts').style.display = 'block';
    
    // Populate data immediately
    populateAllData();
    
    // Show sections based on current format
    const format = document.getElementById('reportFormat').value;
    showReportSections(format);
    
    // Initialize charts
    setTimeout(() => initializeCharts(), 100);
    
    updateSelectionInfo();
}

function removeFromSelected(element) {
    element.remove();
    updateSelectionInfo();
}

function clearSelection() {
    document.querySelectorAll('.session-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    document.getElementById('selectedSessions').innerHTML = '';
    updateSelectionInfo();
}

function handleFormatChange() {
    const format = document.getElementById('reportFormat').value;
    showReportSections(format);
}

function showReportSections(format) {
    // Hide all optional sections first
    const sections = ['detailedAnalytics', 'topRisksSection', 'recommendationsSection', 'auditSection', 'enhancedDataSection'];
    sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) section.style.display = 'none';
    });
    
    // Show sections based on format
    switch(format) {
        case 'executive':
            // Executive shows only summary cards and main charts
            break;
        case 'detailed':
            // Detailed shows enhanced data and analytics
            document.getElementById('detailedAnalytics').style.display = 'block';
            document.getElementById('topRisksSection').style.display = 'block';
            document.getElementById('enhancedDataSection').style.display = 'block';
            break;
        case 'technical':
            // Technical shows everything including audit and recommendations
            document.getElementById('detailedAnalytics').style.display = 'block';
            document.getElementById('topRisksSection').style.display = 'block';
            document.getElementById('recommendationsSection').style.display = 'block';
            document.getElementById('auditSection').style.display = 'block';
            document.getElementById('enhancedDataSection').style.display = 'block';
            break;
    }
    
    // Initialize charts for visible sections
    initializeCharts();
}

function handlePeriodChange() {
    const period = document.getElementById('reportPeriod').value;
    const customRange = document.getElementById('customDateRange');
    
    if (period === 'custom') {
        customRange.style.display = 'block';
    } else {
        customRange.style.display = 'none';
    }
}

function updateReport() {
    const format = document.getElementById('reportFormat').value;
    showReportSections(format);
    
    // Ensure data is populated
    populateAllData();
    
    // Re-initialize charts for new format
    setTimeout(() => initializeCharts(), 100);
}

function populateAllData() {
    // Populate summary cards with actual data
    const summaryData = {
        'totalEmailsProcessed': { value: 9000, growth: '15%' },
        'securityIncidents': { value: 2260, rate: '25.1%' },
        'casesResolved': { value: 0, rate: '0.0%' },
        'avgResponseTime': { value: '2.5h', improvement: '8%' }
    };
    
    // Set main numbers
    document.getElementById('totalEmailsProcessed').textContent = '9,000';
    document.getElementById('securityIncidents').textContent = '2,260';
    document.getElementById('casesResolved').textContent = '0';
    document.getElementById('avgResponseTime').textContent = '2.5h';
    
    // Set growth/rate indicators
    document.getElementById('emailsGrowth').textContent = '15%';
    document.getElementById('incidentsRate').textContent = '25.1%';
    document.getElementById('resolutionRate').textContent = '0.0%';
    document.getElementById('responseImprovement').textContent = '8%';
}

function animateNumbers() {
    // Just update the display immediately - no animation for faster loading
    populateAllData();
}

function initializeCharts() {
    // Destroy existing charts first to prevent duplication
    const riskTrendCtx = document.getElementById('riskTrendChart');
    if (riskTrendCtx && riskTrendCtx.chart) {
        riskTrendCtx.chart.destroy();
    }
    
    const riskDistCtx = document.getElementById('riskDistributionChart');
    if (riskDistCtx && riskDistCtx.chart) {
        riskDistCtx.chart.destroy();
    }
    
    const deptVolumeCtx = document.getElementById('departmentVolumeChart');
    if (deptVolumeCtx && deptVolumeCtx.chart) {
        deptVolumeCtx.chart.destroy();
    }
    
    const threatDomainsCtx = document.getElementById('threatDomainsChart');
    if (threatDomainsCtx && threatDomainsCtx.chart) {
        threatDomainsCtx.chart.destroy();
    }
    
    // Destroy enhanced charts
    const auditTimelineCtx = document.getElementById('auditTimelineChart');
    if (auditTimelineCtx && auditTimelineCtx.chart) {
        auditTimelineCtx.chart.destroy();
    }
    
    const timeAnalysisCtx = document.getElementById('timeAnalysisChart');
    if (timeAnalysisCtx && timeAnalysisCtx.chart) {
        timeAnalysisCtx.chart.destroy();
    }
    
    const communicationCtx = document.getElementById('communicationChart');
    if (communicationCtx && communicationCtx.chart) {
        communicationCtx.chart.destroy();
    }
    
    const senderAnalysisCtx = document.getElementById('senderAnalysisChart');
    if (senderAnalysisCtx && senderAnalysisCtx.chart) {
        senderAnalysisCtx.chart.destroy();
    }
    
    const contentAnalysisCtx = document.getElementById('contentAnalysisChart');
    if (contentAnalysisCtx && contentAnalysisCtx.chart) {
        contentAnalysisCtx.chart.destroy();
    }
    
    // Initialize Risk Trend Chart
    if (riskTrendCtx) {
        riskTrendCtx.chart = new Chart(riskTrendCtx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'High Risk',
                    data: [350, 280, 450, 320],
                    borderColor: '#e74a3b',
                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Medium Risk', 
                    data: [650, 720, 580, 690],
                    borderColor: '#f6c23e',
                    backgroundColor: 'rgba(246, 194, 62, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Low Risk',
                    data: [1200, 1150, 1300, 1180],
                    borderColor: '#1cc88a', 
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Initialize Risk Distribution Chart
    if (riskDistCtx) {
        riskDistCtx.chart = new Chart(riskDistCtx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [124, 2136, 4820, 1920],
                    backgroundColor: ['#e74a3b', '#fd7e14', '#f6c23e', '#1cc88a'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Initialize Department Volume Chart
    if (deptVolumeCtx) {
        deptVolumeCtx.chart = new Chart(deptVolumeCtx, {
            type: 'bar',
            data: {
                labels: ['Finance', 'HR', 'IT', 'Sales', 'Marketing'],
                datasets: [{
                    label: 'Email Volume',
                    data: [2400, 1800, 3200, 2100, 1500],
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Initialize Threat Domains Chart
    if (threatDomainsCtx) {
        threatDomainsCtx.chart = new Chart(threatDomainsCtx, {
            type: 'horizontalBar',
            data: {
                labels: ['suspicious-domain.com', 'phishing-site.org', 'malware-host.net', 'spam-sender.biz', 'fake-bank.co'],
                datasets: [{
                    label: 'Threat Count',
                    data: [45, 38, 32, 28, 24],
                    backgroundColor: '#e74a3b',
                    borderColor: '#c0392b',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Initialize Enhanced Charts
    initializeEnhancedCharts();
}

function initializeEnhancedCharts() {
    // Initialize Audit Timeline Chart
    const auditTimelineCtx = document.getElementById('auditTimelineChart');
    if (auditTimelineCtx) {
        auditTimelineCtx.chart = new Chart(auditTimelineCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                datasets: [{
                    label: 'System Activity',
                    data: [12, 8, 25, 45, 38, 15],
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Security Events',
                    data: [2, 1, 5, 8, 6, 3],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
    
    // Initialize Time Analysis Chart
    const timeAnalysisCtx = document.getElementById('timeAnalysisChart');
    if (timeAnalysisCtx) {
        timeAnalysisCtx.chart = new Chart(timeAnalysisCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Email Volume',
                    data: [1200, 1500, 1800, 1600, 1400, 400, 300],
                    backgroundColor: '#4e73df'
                }, {
                    label: 'Risk Incidents',
                    data: [120, 180, 220, 190, 150, 45, 35],
                    backgroundColor: '#e74a3b'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
    
    // Initialize Communication Chart
    const communicationCtx = document.getElementById('communicationChart');
    if (communicationCtx) {
        communicationCtx.chart = new Chart(communicationCtx, {
            type: 'radar',
            data: {
                labels: ['Internal', 'External', 'Personal', 'Automated', 'Suspicious'],
                datasets: [{
                    label: 'Communication Patterns',
                    data: [85, 45, 25, 65, 15],
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.2)',
                    pointBackgroundColor: '#1cc88a'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
    
    // Initialize Sender Analysis Chart
    const senderAnalysisCtx = document.getElementById('senderAnalysisChart');
    if (senderAnalysisCtx) {
        senderAnalysisCtx.chart = new Chart(senderAnalysisCtx, {
            type: 'pie',
            data: {
                labels: ['Corporate', 'External', 'Personal', 'Unknown'],
                datasets: [{
                    data: [65, 20, 10, 5],
                    backgroundColor: ['#4e73df', '#f6c23e', '#1cc88a', '#e74a3b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Initialize Content Analysis Chart
    const contentAnalysisCtx = document.getElementById('contentAnalysisChart');
    if (contentAnalysisCtx) {
        contentAnalysisCtx.chart = new Chart(contentAnalysisCtx, {
            type: 'doughnut',
            data: {
                labels: ['Business', 'Personal', 'Marketing', 'Security Risk'],
                datasets: [{
                    data: [45, 25, 20, 10],
                    backgroundColor: ['#36b9cc', '#1cc88a', '#f6c23e', '#e74a3b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

function refreshDashboard() {
    location.reload();
}

function exportMonthlyReport() {
    alert('PDF export functionality would be implemented here');
}

function exportExcelReport() {
    alert('Excel export functionality would be implemented here');
}
</script>
{% endblock %}
