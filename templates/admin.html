{% extends "base.html" %}

{% block title %}Admin Panel - Email Guardian{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active">Admin Panel</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-cog text-primary me-2"></i>
                System Administration
            </h1>
            <div class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>
                System Online
            </div>
        </div>
    </div>
</div>

<!-- System Statistics -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_sessions }}</h4>
                        <p class="card-text">Total Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.active_sessions }}</h4>
                        <p class="card-text">Active Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-spinner fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.completed_sessions }}</h4>
                        <p class="card-text">Completed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.failed_sessions }}</h4>
                        <p class="card-text">Failed Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>
                    System Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="cleanupOldSessions()">
                        <i class="fas fa-broom me-2"></i>
                        Clean Old Sessions
                    </button>
                    <button class="btn btn-outline-warning" onclick="clearUploads()">
                        <i class="fas fa-trash me-2"></i>
                        Clear Upload Folder
                    </button>
                    <button class="btn btn-outline-info" onclick="exportSettings()">
                        <i class="fas fa-download me-2"></i>
                        Export Settings
                    </button>
                    <button class="btn btn-outline-success" onclick="testDatabase()">
                        <i class="fas fa-database me-2"></i>
                        Test Database
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="mb-3">
                        <label class="form-label">Max File Size (MB)</label>
                        <input type="number" class="form-control" value="16" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Session Timeout (hours)</label>
                        <input type="number" class="form-control" value="24" min="1" max="168">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">Debug Mode</label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>
                        Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Whitelist Management -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Whitelist Domains
                </h5>
            </div>
            <div class="card-body">
                <div id="whitelistDomains">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading whitelist domains...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Rules Management
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('rules') }}" class="btn btn-outline-primary">
                        <i class="fas fa-shield-virus me-2"></i>
                        Security Rules
                    </a>
                    <a href="{{ url_for('rules') }}" class="btn btn-outline-warning">
                        <i class="fas fa-filter me-2"></i>
                        Exclusion Rules
                    </a>
                    <button class="btn btn-outline-info" onclick="window.showMLKeywords()" id="mlKeywordsBtn">
                        <i class="fas fa-brain me-2"></i>
                        ML Keywords
                    </button>
                </div>
                <div id="mlKeywordsContainer" style="display: none;" class="mt-3">
                    <div id="mlKeywords">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading ML keywords...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Risk Scoring Algorithm Transparency -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain text-primary me-2"></i>
                    Risk Scoring Algorithm Transparency
                </h5>
                <p class="text-muted small mb-0">How the machine learning engine calculates risk scores</p>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Algorithm Overview -->
                    <div class="col-lg-6 mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-info-circle text-info me-2"></i>Algorithm Components
                        </h6>
                        
                        <!-- Anomaly Detection -->
                        <div class="algorithm-component mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 text-primary">Anomaly Detection</h6>
                                <span class="badge bg-primary">{{ risk_scoring_info.algorithm_components.anomaly_detection.weight }}% Weight</span>
                            </div>
                            <p class="text-muted small mb-2">{{ risk_scoring_info.algorithm_components.anomaly_detection.description }}</p>
                            <div class="row text-sm">
                                <div class="col-6">
                                    <strong>Method:</strong> {{ risk_scoring_info.algorithm_components.anomaly_detection.method.split('.')[-1] }}
                                </div>
                                <div class="col-6">
                                    <strong>Estimators:</strong> {{ risk_scoring_info.algorithm_components.anomaly_detection.estimators }}
                                </div>
                                <div class="col-6 mt-1">
                                    <strong>Contamination:</strong> {{ risk_scoring_info.algorithm_components.anomaly_detection.contamination_rate }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rule-Based Factors -->
                        <div class="algorithm-component mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 text-success">Rule-Based Factors</h6>
                                <div>
                                    <span class="badge bg-success me-2">{{ risk_scoring_info.algorithm_components.rule_based_factors.weight }}% Weight</span>
                                    <button class="btn btn-sm btn-outline-success" onclick="toggleMLEditor()">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Read-only view -->
                            <div id="ml-factors-view" class="rule-factors">
                                {% for factor in risk_scoring_info.algorithm_components.rule_based_factors.factors %}
                                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                    <div>
                                        <small class="fw-bold">{{ factor.name }}</small>
                                        <br><small class="text-muted">{{ factor.description }}</small>
                                    </div>
                                    <div class="text-end">
                                        <small class="fw-bold">Max: {{ "%.1f"|format(factor.max_score) }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Editable view -->
                            <div id="ml-factors-editor" style="display: none;">
                                <div class="mb-3">
                                    <h6 class="text-primary">Edit ML Risk Factors</h6>
                                    <small class="text-muted">Adjust maximum risk scores for each factor (0.0 - 1.0)</small>
                                </div>
                                
                                <div id="ml-factor-inputs">
                                    {% for factor in risk_scoring_info.algorithm_components.rule_based_factors.factors %}
                                    <div class="row mb-2 align-items-center">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">{{ factor.name }}</label>
                                            <small class="d-block text-muted">{{ factor.description }}</small>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" 
                                                   class="form-control form-control-sm ml-factor-input" 
                                                   data-factor="{{ factor.name.lower().replace(' ', '_') }}"
                                                   value="{{ "%.1f"|format(factor.max_score) }}" 
                                                   min="0.0" 
                                                   max="1.0" 
                                                   step="0.1">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-sm btn-outline-danger" onclick="removeMLFactor(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <button class="btn btn-sm btn-outline-primary" onclick="addMLFactor()">
                                            <i class="fas fa-plus me-1"></i>Add New Factor
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="saveMLConfiguration()">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="cancelMLEdit()">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="resetMLDefaults()">
                                        <i class="fas fa-undo me-1"></i>Reset to Defaults
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Thresholds & Attachment Scoring -->
                    <div class="col-lg-6 mb-4">
                        <!-- Risk Level Thresholds -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">
                                <i class="fas fa-chart-line text-warning me-2"></i>Risk Level Thresholds
                            </h6>
                            <button class="btn btn-sm btn-outline-warning" onclick="toggleThresholdEditor()">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                        </div>
                        
                        <!-- Read-only threshold view -->
                        <div id="thresholds-view" class="risk-thresholds mb-4">
                            {% for level, threshold in risk_scoring_info.thresholds.items() %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="d-flex align-items-center">
                                    {% if level == 'critical' %}
                                        <div class="badge bg-danger me-2">Critical</div>
                                    {% elif level == 'high' %}
                                        <div class="badge bg-warning me-2">High</div>
                                    {% elif level == 'medium' %}
                                        <div class="badge bg-info me-2">Medium</div>
                                    {% else %}
                                        <div class="badge bg-secondary me-2">Low</div>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <strong>≥ {{ threshold }}</strong>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Editable threshold view -->
                        <div id="thresholds-editor" style="display: none;" class="mb-4">
                            <div class="mb-3">
                                <h6 class="text-warning">Edit Risk Thresholds</h6>
                                <small class="text-muted">Set minimum scores for each risk level (0.0 - 1.0)</small>
                            </div>
                            
                            <div id="threshold-inputs">
                                {% for level, threshold in risk_scoring_info.thresholds.items() %}
                                <div class="row mb-2 align-items-center">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            {% if level == 'critical' %}
                                                <div class="badge bg-danger me-2">Critical</div>
                                            {% elif level == 'high' %}
                                                <div class="badge bg-warning me-2">High</div>
                                            {% elif level == 'medium' %}
                                                <div class="badge bg-info me-2">Medium</div>
                                            {% else %}
                                                <div class="badge bg-secondary me-2">Low</div>
                                            {% endif %}
                                            <span class="small">{{ level.title() }} Risk</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="number" 
                                               class="form-control form-control-sm threshold-input" 
                                               data-level="{{ level }}"
                                               value="{{ threshold }}" 
                                               min="0.0" 
                                               max="1.0" 
                                               step="0.1"
                                               placeholder="≥ threshold">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-warning" onclick="saveThresholds()">
                                    <i class="fas fa-save me-1"></i>Save Thresholds
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelThresholdEdit()">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </div>
                        
                        <!-- Attachment Risk Scoring -->
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-paperclip text-danger me-2"></i>Attachment Risk Scoring
                        </h6>
                        <div class="attachment-scoring">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="fw-bold text-danger">High Risk Extensions</small>
                                    <small class="fw-bold">+{{ risk_scoring_info.attachment_scoring.high_risk_score }}</small>
                                </div>
                                <div class="extension-list">
                                    {% for ext in risk_scoring_info.attachment_scoring.high_risk_extensions %}
                                        <span class="badge bg-danger me-1">{{ ext }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="fw-bold text-warning">Medium Risk Extensions</small>
                                    <small class="fw-bold">+{{ risk_scoring_info.attachment_scoring.medium_risk_score }}</small>
                                </div>
                                <div class="extension-list">
                                    {% for ext in risk_scoring_info.attachment_scoring.medium_risk_extensions %}
                                        <span class="badge bg-warning me-1">{{ ext }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="fw-bold text-info">Suspicious Patterns</small>
                                    <small class="fw-bold">+{{ risk_scoring_info.attachment_scoring.pattern_score }}</small>
                                </div>
                                <div class="pattern-list">
                                    {% for pattern in risk_scoring_info.attachment_scoring.suspicious_patterns %}
                                        <span class="badge bg-info me-1">{{ pattern }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Configuration -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-tachometer-alt text-secondary me-2"></i>Performance Configuration
                        </h6>
                        <div class="row">
                            <div class="col-md-2">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-{{ 'success' if risk_scoring_info.performance_config.fast_mode else 'secondary' }}">
                                        {{ 'ON' if risk_scoring_info.performance_config.fast_mode else 'OFF' }}
                                    </div>
                                    <small class="text-muted">Fast Mode</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-primary">{{ risk_scoring_info.performance_config.max_ml_records }}</div>
                                    <small class="text-muted">Max Records</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-info">{{ risk_scoring_info.performance_config.ml_estimators }}</div>
                                    <small class="text-muted">ML Estimators</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-warning">{{ risk_scoring_info.performance_config.tfidf_max_features }}</div>
                                    <small class="text-muted">TF-IDF Features</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-success">{{ risk_scoring_info.performance_config.chunk_size }}</div>
                                    <small class="text-muted">Chunk Size</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Performance Monitoring -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt text-success me-2"></i>
                    System Performance Monitor
                </h5>
                <p class="text-muted small mb-0">Real-time system resource utilization and processing metrics</p>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" id="cpu-progress" style="width: 0%"></div>
                                </div>
                                <h6 class="mb-1" id="cpu-usage">0%</h6>
                                <small class="text-muted">CPU Usage</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-info" id="memory-progress" style="width: 0%"></div>
                                </div>
                                <h6 class="mb-1" id="memory-usage">0%</h6>
                                <small class="text-muted">Memory Usage</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="mb-1" id="active-threads">0</h6>
                                <small class="text-muted">Active Threads</small>
                                <div class="mt-1">
                                    <span class="badge bg-primary" id="processing-threads">0 Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="mb-1" id="avg-response-time">0ms</h6>
                                <small class="text-muted">Avg Response Time</small>
                                <div class="mt-1">
                                    <span class="badge bg-warning" id="slow-requests">0 Slow</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <canvas id="performance-chart" width="400" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security Alerts & Insights -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt text-danger me-2"></i>
                    Security Alert Dashboard
                </h5>
                <p class="text-muted small mb-0">Real-time threat detection and security insights</p>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-2 bg-danger bg-opacity-10 rounded">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <div>
                                <div class="fw-bold text-danger" id="critical-threats">0</div>
                                <small class="text-muted">Critical Threats</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-2 bg-warning bg-opacity-10 rounded">
                            <i class="fas fa-eye text-warning me-2"></i>
                            <div>
                                <div class="fw-bold text-warning" id="suspicious-activities">0</div>
                                <small class="text-muted">Suspicious Activities</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-2 bg-info bg-opacity-10 rounded">
                            <i class="fas fa-ban text-info me-2"></i>
                            <div>
                                <div class="fw-bold text-info" id="blocked-domains">0</div>
                                <small class="text-muted">Blocked Domains</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Security Events -->
                <div class="security-events" style="max-height: 300px; overflow-y: auto;">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-clock me-1"></i>Recent Security Events
                    </h6>
                    <div id="security-events-list">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading security events...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie text-primary me-2"></i>
                    Threat Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="threat-distribution-chart" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Analytics & Insights -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-info me-2"></i>
                    Data Analytics & Processing Insights
                </h5>
                <p class="text-muted small mb-0">Comprehensive analysis of processed email data and patterns</p>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-primary" id="total-emails-processed">0</div>
                            <small class="text-muted">Total Emails Processed</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-success" id="clean-emails">0</div>
                            <small class="text-muted">Clean Emails</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-warning" id="flagged-emails">0</div>
                            <small class="text-muted">Flagged Emails</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-danger" id="high-risk-emails">0</div>
                            <small class="text-muted">High Risk</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-info" id="unique-domains">0</div>
                            <small class="text-muted">Unique Domains</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-secondary" id="avg-processing-time">0s</div>
                            <small class="text-muted">Avg Processing Time</small>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Email Volume Trends</h6>
                        <canvas id="email-volume-chart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Risk Level Distribution</h6>
                        <canvas id="risk-level-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced System Management -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs text-secondary me-2"></i>
                    Advanced System Management
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6 class="fw-bold">Database Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info" onclick="optimizeDatabase()">
                                <i class="fas fa-database me-2"></i>Optimize Database
                            </button>
                            <button class="btn btn-outline-warning" onclick="rebuildIndexes()">
                                <i class="fas fa-wrench me-2"></i>Rebuild Indexes
                            </button>
                            <button class="btn btn-outline-primary" onclick="backupDatabase()">
                                <i class="fas fa-save me-2"></i>Create Backup
                            </button>
                        </div>
                    </div>
                    <div class="col-12">
                        <h6 class="fw-bold">ML Model Management</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success" onclick="retrainModels()">
                                <i class="fas fa-brain me-2"></i>Retrain Models
                            </button>
                            <button class="btn btn-outline-info" onclick="updateMLKeywords()">
                                <i class="fas fa-tags me-2"></i>Update Keywords
                            </button>
                            <button class="btn btn-outline-warning" onclick="validateModels()">
                                <i class="fas fa-check-circle me-2"></i>Validate Models
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download text-primary me-2"></i>
                    Export & Reporting
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="fw-bold">System Reports</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="exportSystemReport()">
                            <i class="fas fa-file-alt me-2"></i>System Health Report
                        </button>
                        <button class="btn btn-outline-info" onclick="exportSecurityReport()">
                            <i class="fas fa-shield-alt me-2"></i>Security Analysis Report
                        </button>
                        <button class="btn btn-outline-success" onclick="exportPerformanceReport()">
                            <i class="fas fa-tachometer-alt me-2"></i>Performance Report
                        </button>
                    </div>
                </div>
                <div>
                    <h6 class="fw-bold">Data Export</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-warning" onclick="exportAllSessions()">
                            <i class="fas fa-database me-2"></i>Export All Sessions
                        </button>
                        <button class="btn btn-outline-secondary" onclick="exportConfiguration()">
                            <i class="fas fa-cog me-2"></i>Export Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Logs & Debugging -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-alt text-warning me-2"></i>
                            System Logs & Debugging
                        </h5>
                        <p class="text-muted small mb-0">Real-time system logs and debugging information</p>
                    </div>
                    <div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="clearLogs()">
                                <i class="fas fa-trash me-1"></i>Clear
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="downloadLogs()">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="log-level-filter">
                            <option value="all">All Levels</option>
                            <option value="error">Errors Only</option>
                            <option value="warning">Warnings</option>
                            <option value="info">Info</option>
                            <option value="debug">Debug</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="log-component-filter">
                            <option value="all">All Components</option>
                            <option value="ml_engine">ML Engine</option>
                            <option value="data_processor">Data Processor</option>
                            <option value="rule_engine">Rule Engine</option>
                            <option value="session_manager">Session Manager</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="auto-refresh-logs" checked>
                            <label class="form-check-label" for="auto-refresh-logs">Auto Refresh</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="follow-logs" checked>
                            <label class="form-check-label" for="follow-logs">Follow Logs</label>
                        </div>
                    </div>
                </div>
                <div class="log-container" style="height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; font-family: monospace; font-size: 12px;">
                    <div id="system-logs">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading system logs...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Sessions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Sessions
                </h5>
            </div>
            <div class="card-body">
                {% if recent_sessions %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Filename</th>
                                <th>Upload Time</th>
                                <th>Status</th>
                                <th>Records</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>
                                    <code>{{ session.id[:8] }}...</code>
                                </td>
                                <td>{{ session.filename }}</td>
                                <td>{{ session.upload_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if session.status == 'completed' %}
                                        <span class="badge bg-success">{{ session.status }}</span>
                                    {% elif session.status == 'processing' %}
                                        <span class="badge bg-warning">{{ session.status }}</span>
                                    {% elif session.status == 'failed' %}
                                        <span class="badge bg-danger">{{ session.status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ session.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ session.total_records or 0 }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('dashboard', session_id=session.id) }}" 
                                           class="btn btn-outline-primary" title="View Dashboard">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteSession('{{ session.id }}')" 
                                                title="Delete Session">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No sessions found</h5>
                    <p class="text-muted">Upload some files to see session data here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function cleanupOldSessions() {
    if (confirm('This will remove sessions older than 7 days. Continue?')) {
        showAlert('Old sessions cleaned successfully!', 'success');
    }
}

function clearUploads() {
    if (confirm('This will delete all uploaded files. Continue?')) {
        showAlert('Upload folder cleared successfully!', 'success');
    }
}

function exportSettings() {
    showAlert('Settings exported to downloads folder!', 'info');
}

function testDatabase() {
    showAlert('Database connection test successful!', 'success');
}

function saveConfig() {
    showAlert('Configuration saved successfully!', 'success');
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session? This action cannot be undone and will remove all associated data.')) {
        fetch(`/admin/session/${sessionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'deleted') {
                showSuccess('Session deleted successfully');
                setTimeout(() => location.reload(), 1000);
            } else if (data.error) {
                showError('Error deleting session: ' + data.error);
            } else {
                showError('Unknown error occurred while deleting session');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Network error occurred while deleting session');
        });
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}



function loadWhitelistDomains() {
    const container = document.getElementById('whitelistDomains');
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading whitelist domains...</p></div>';
    
    fetch('/api/whitelist-domains')
        .then(response => response.json())
        .then(domains => {
            if (domains.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-shield-alt fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No whitelist domains found</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAddDomainForm()">
                            <i class="fas fa-plus"></i> Add Domain
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Whitelist Domains (${domains.length})</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showAddDomainForm()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            domains.forEach(domain => {
                html += `
                    <tr>
                        <td><code>${domain.domain}</code></td>
                        <td><span class="badge bg-secondary">${domain.domain_type}</span></td>
                        <td>
                            <span class="badge bg-${domain.is_active ? 'success' : 'warning'}">
                                ${domain.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-${domain.is_active ? 'warning' : 'success'}" 
                                        onclick="toggleDomainStatus(${domain.id})" 
                                        title="${domain.is_active ? 'Deactivate' : 'Activate'}">
                                    <i class="fas fa-${domain.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteDomain(${domain.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading whitelist domains:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-3">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Failed to load whitelist domains</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadWhitelistDomains()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        });
}

function showAddDomainForm() {
    const domain = prompt('Enter domain to add to whitelist:');
    if (domain && domain.trim()) {
        addDomainToWhitelist(domain.trim());
    }
}

function addDomainToWhitelist(domain) {
    fetch('/api/whitelist-domains', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            domain: domain,
            domain_type: 'Corporate',
            added_by: 'Admin'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error adding domain:', error);
        showError('Failed to add domain to whitelist');
    });
}

function toggleDomainStatus(domainId) {
    fetch(`/api/whitelist-domains/${domainId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error toggling domain status:', error);
        showError('Failed to update domain status');
    });
}

function deleteDomain(domainId) {
    if (confirm('Are you sure you want to delete this whitelist domain?')) {
        fetch(`/api/whitelist-domains/${domainId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                loadWhitelistDomains();
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting domain:', error);
            showError('Failed to delete domain');
        });
    }
}

// ML Configuration Editor Functions
let currentMLConfig = {};

function toggleMLEditor() {
    const viewDiv = document.getElementById('ml-factors-view');
    const editorDiv = document.getElementById('ml-factors-editor');
    
    if (editorDiv.style.display === 'none') {
        viewDiv.style.display = 'none';
        editorDiv.style.display = 'block';
    } else {
        viewDiv.style.display = 'block';
        editorDiv.style.display = 'none';
    }
}

function saveMLConfiguration() {
    const factors = [];
    document.querySelectorAll('.ml-factor-input').forEach(input => {
        factors.push({
            name: input.dataset.factor,
            max_score: parseFloat(input.value)
        });
    });
    
    fetch('/admin/ml-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ factors })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ML configuration saved successfully');
            location.reload();
        } else {
            showError('Failed to save ML configuration: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving ML config:', error);
        showError('Failed to save ML configuration');
    });
}

function cancelMLEdit() {
    toggleMLEditor();
}

function resetMLDefaults() {
    if (confirm('Reset all ML factors to default values?')) {
        fetch('/admin/ml-config/reset', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('ML configuration reset to defaults');
                location.reload();
            } else {
                showError('Failed to reset ML configuration');
            }
        });
    }
}

// Performance monitoring functions
let performanceChart;
let threatDistributionChart;
let emailVolumeChart;
let riskLevelChart;

function initializeCharts() {
    // Performance Chart
    const performanceCtx = document.getElementById('performance-chart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU %',
                borderColor: '#28a745',
                data: [],
                fill: false
            }, {
                label: 'Memory %',
                borderColor: '#17a2b8',
                data: [],
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });

    // Threat Distribution Chart
    const threatCtx = document.getElementById('threat-distribution-chart').getContext('2d');
    threatDistributionChart = new Chart(threatCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High Risk', 'Medium Risk', 'Low Risk'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Email Volume Chart
    const emailVolumeCtx = document.getElementById('email-volume-chart').getContext('2d');
    emailVolumeChart = new Chart(emailVolumeCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Emails Processed',
                backgroundColor: '#007bff',
                data: []
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Risk Level Chart
    const riskLevelCtx = document.getElementById('risk-level-chart').getContext('2d');
    riskLevelChart = new Chart(riskLevelCtx, {
        type: 'pie',
        data: {
            labels: ['Clean', 'Flagged', 'High Risk'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function updatePerformanceMetrics() {
    fetch('/admin/api/performance-metrics')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Update performance indicators with null checks
        const cpuElement = document.getElementById('cpu-usage');
        const memoryElement = document.getElementById('memory-usage');
        const threadsElement = document.getElementById('active-threads');
        const processingElement = document.getElementById('processing-threads');
        const responseElement = document.getElementById('avg-response-time');
        const slowElement = document.getElementById('slow-requests');
        
        if (cpuElement) {
            cpuElement.textContent = data.cpu_usage + '%';
            const cpuProgress = document.getElementById('cpu-progress');
            if (cpuProgress) cpuProgress.style.width = data.cpu_usage + '%';
        }
        
        if (memoryElement) {
            memoryElement.textContent = data.memory_usage + '%';
            const memoryProgress = document.getElementById('memory-progress');
            if (memoryProgress) memoryProgress.style.width = data.memory_usage + '%';
        }
        
        if (threadsElement) threadsElement.textContent = data.active_threads;
        if (processingElement) processingElement.textContent = data.processing_threads + ' Processing';
        if (responseElement) responseElement.textContent = data.avg_response_time + 'ms';
        if (slowElement) slowElement.textContent = data.slow_requests + ' Slow';

        // Update performance chart only if it exists
        if (typeof performanceChart !== 'undefined' && performanceChart) {
            const now = new Date().toLocaleTimeString();
            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push(data.cpu_usage);
            performanceChart.data.datasets[1].data.push(data.memory_usage);
            
            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
            }
            
            performanceChart.update();
        }
    })
    .catch(error => {
        // Silently handle errors for background updates to avoid console spam
    });
}

function updateSecurityMetrics() {
    fetch('/admin/api/security-metrics')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const criticalElement = document.getElementById('critical-threats');
        const suspiciousElement = document.getElementById('suspicious-activities');
        const blockedElement = document.getElementById('blocked-domains');
        
        if (criticalElement) criticalElement.textContent = data.critical_threats;
        if (suspiciousElement) suspiciousElement.textContent = data.suspicious_activities;
        if (blockedElement) blockedElement.textContent = data.blocked_domains;

        // Update threat distribution chart only if it exists
        if (typeof threatDistributionChart !== 'undefined' && threatDistributionChart) {
            threatDistributionChart.data.datasets[0].data = [
                data.threat_distribution.critical,
                data.threat_distribution.high,
                data.threat_distribution.medium,
                data.threat_distribution.low
            ];
            threatDistributionChart.update();
        }

        // Update security events
        updateSecurityEvents(data.recent_events);
    })
    .catch(error => {
        // Silently handle errors for background updates
    });
}

function updateSecurityEvents(events) {
    const container = document.getElementById('security-events-list');
    if (!events || events.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">No recent security events</div>';
        return;
    }

    let html = '';
    events.forEach(event => {
        const timeAgo = getTimeAgo(new Date(event.timestamp));
        const iconClass = event.severity === 'critical' ? 'fa-exclamation-triangle text-danger' :
                         event.severity === 'warning' ? 'fa-eye text-warning' : 'fa-info-circle text-info';
        
        html += `
            <div class="d-flex align-items-start mb-2 p-2 bg-light rounded">
                <i class="fas ${iconClass} me-2 mt-1"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${event.title}</div>
                    <small class="text-muted">${event.description}</small>
                    <div class="text-muted small">${timeAgo}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateDataAnalytics() {
    fetch('/admin/api/data-analytics')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const totalElement = document.getElementById('total-emails-processed');
        const cleanElement = document.getElementById('clean-emails');
        const flaggedElement = document.getElementById('flagged-emails');
        const highRiskElement = document.getElementById('high-risk-emails');
        const domainsElement = document.getElementById('unique-domains');
        const timeElement = document.getElementById('avg-processing-time');
        
        if (totalElement) totalElement.textContent = data.total_emails.toLocaleString();
        if (cleanElement) cleanElement.textContent = data.clean_emails.toLocaleString();
        if (flaggedElement) flaggedElement.textContent = data.flagged_emails.toLocaleString();
        if (highRiskElement) highRiskElement.textContent = data.high_risk_emails.toLocaleString();
        if (domainsElement) domainsElement.textContent = data.unique_domains.toLocaleString();
        if (timeElement) timeElement.textContent = data.avg_processing_time + 's';

        // Update charts only if they exist
        if (typeof emailVolumeChart !== 'undefined' && emailVolumeChart) {
            emailVolumeChart.data.labels = data.volume_trends.labels;
            emailVolumeChart.data.datasets[0].data = data.volume_trends.data;
            emailVolumeChart.update();
        }

        if (typeof riskLevelChart !== 'undefined' && riskLevelChart) {
            riskLevelChart.data.datasets[0].data = [
                data.clean_emails,
                data.flagged_emails,
                data.high_risk_emails
            ];
            riskLevelChart.update();
        }
    })
    .catch(error => {
        // Silently handle errors for background updates
    });
}

function updateSystemLogs() {
    if (!document.getElementById('auto-refresh-logs').checked) return;
    
    const level = document.getElementById('log-level-filter').value;
    const component = document.getElementById('log-component-filter').value;
    
    fetch(`/admin/api/system-logs?level=${level}&component=${component}`)
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('system-logs');
        if (!data.logs || data.logs.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">No logs found</div>';
            return;
        }

        let html = '';
        data.logs.forEach(log => {
            const levelClass = log.level === 'ERROR' ? 'text-danger' :
                              log.level === 'WARNING' ? 'text-warning' :
                              log.level === 'INFO' ? 'text-info' : 'text-muted';
            
            html += `
                <div class="log-entry mb-1">
                    <span class="text-muted">[${log.timestamp}]</span>
                    <span class="${levelClass} fw-bold">[${log.level}]</span>
                    <span class="text-primary">[${log.component}]</span>
                    <span>${log.message}</span>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Auto-scroll to bottom if follow logs is enabled
        if (document.getElementById('follow-logs').checked) {
            container.scrollTop = container.scrollHeight;
        }
    })
    .catch(error => console.error('Error updating system logs:', error));
}

// Advanced system management functions
function optimizeDatabase() {
    if (confirm('This will optimize the database. Continue?')) {
        fetch('/admin/api/optimize-database', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Database optimized successfully');
            } else {
                showError('Failed to optimize database: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error optimizing database:', error);
            showError('Failed to optimize database');
        });
    }
}

function rebuildIndexes() {
    if (confirm('This will rebuild database indexes. Continue?')) {
        fetch('/admin/api/rebuild-indexes', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Database indexes rebuilt successfully');
            } else {
                showError('Failed to rebuild indexes: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error rebuilding indexes:', error);
            showError('Failed to rebuild indexes');
        });
    }
}

function backupDatabase() {
    fetch('/admin/api/backup-database', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Database backup created: ' + data.filename);
        } else {
            showError('Failed to create backup: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating backup:', error);
        showError('Failed to create database backup');
    });
}

function retrainModels() {
    if (confirm('This will retrain ML models using current data. This may take several minutes. Continue?')) {
        fetch('/admin/api/retrain-models', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('ML models retrained successfully');
            } else {
                showError('Failed to retrain models: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error retraining models:', error);
            showError('Failed to retrain ML models');
        });
    }
}

function updateMLKeywords() {
    fetch('/admin/api/update-ml-keywords', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ML keywords updated successfully');
        } else {
            showError('Failed to update keywords: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating ML keywords:', error);
        showError('Failed to update ML keywords');
    });
}

function validateModels() {
    fetch('/admin/api/validate-models', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ML models validation completed. Score: ' + data.validation_score);
        } else {
            showError('Failed to validate models: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error validating models:', error);
        showError('Failed to validate ML models');
    });
}

// Export functions
function exportSystemReport() {
    window.open('/admin/export/system-report', '_blank');
}

function exportSecurityReport() {
    window.open('/admin/export/security-report', '_blank');
}

function exportPerformanceReport() {
    window.open('/admin/export/performance-report', '_blank');
}

function exportAllSessions() {
    window.open('/admin/export/all-sessions', '_blank');
}

function exportConfiguration() {
    window.open('/admin/export/configuration', '_blank');
}

// Log management functions
function refreshLogs() {
    updateSystemLogs();
    showSuccess('Logs refreshed');
}

function populateDefaultKeywords() {
    if (confirm('This will add default ML keywords to the database. Continue?')) {
        fetch('/admin/keywords/populate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess(data.message);
                loadMLKeywords(); // Refresh the keywords display
            } else if (data.status === 'info') {
                showSuccess(data.message);
                loadMLKeywords(); // Refresh the keywords display
            } else {
                showError('Failed to populate keywords: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error populating keywords:', error);
            showError('Failed to populate keywords');
        });
    }
}

function refreshMLKeywords() {
    loadMLKeywords();
    showSuccess('ML keywords refreshed');
}

function clearMLKeywords() {
    if (confirm('This will delete ALL ML keywords from the database. This action cannot be undone. Continue?')) {
        fetch('/api/ml-keywords', { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('All ML keywords cleared');
                loadMLKeywords(); // Refresh the keywords display
            } else {
                showError('Failed to clear keywords: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error clearing keywords:', error);
            showError('Failed to clear keywords');
        });
    }
}

function clearLogs() {
    if (confirm('This will clear all system logs. Continue?')) {
        fetch('/admin/api/clear-logs', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('System logs cleared');
                updateSystemLogs();
            } else {
                showError('Failed to clear logs: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error clearing logs:', error);
            showError('Failed to clear logs');
        });
    }
}

function downloadLogs() {
    window.open('/admin/api/download-logs', '_blank');
}

// Utility functions
function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
    };
    
    for (let interval in intervals) {
        const count = Math.floor(seconds / intervals[interval]);
        if (count > 0) {
            return count === 1 ? `1 ${interval} ago` : `${count} ${interval}s ago`;
        }
    }
    return 'Just now';
}

// Simple ML Keywords function
window.showMLKeywords = function() {
    console.log('showMLKeywords called from button click');
    const container = document.getElementById('mlKeywordsContainer');
    const keywordsDiv = document.getElementById('mlKeywords');
    
    if (!container || !keywordsDiv) {
        console.error('Could not find container elements');
        alert('Error: Could not find ML Keywords container elements');
        return;
    }
    
    // Toggle visibility
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        keywordsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Loading ML keywords...</p></div>';
        
        // Fetch data
        fetch('/api/ml-keywords')
            .then(response => {
                console.log('API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ML Keywords data:', data);
                keywordsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-brain me-2"></i>ML Keywords Summary</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Keywords:</strong> ${data.total_keywords || 0}
                            </div>
                            <div class="col-6">
                                <strong>Last Updated:</strong> ${new Date(data.last_updated).toLocaleDateString()}
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-4">
                                <span class="badge bg-success me-2">${data.categories?.Business || 0}</span>
                                Business Keywords
                            </div>
                            <div class="col-4">
                                <span class="badge bg-warning me-2">${data.categories?.Personal || 0}</span>
                                Personal Keywords
                            </div>
                            <div class="col-4">
                                <span class="badge bg-danger me-2">${data.categories?.Suspicious || 0}</span>
                                Suspicious Keywords
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="window.populateDefaultKeywords()">
                                <i class="fas fa-plus me-1"></i>Populate Default
                            </button>
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="window.showMLKeywords()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading ML keywords:', error);
                keywordsDiv.innerHTML = '<div class="alert alert-danger">Error loading ML keywords: ' + error.message + '</div>';
            });
    } else {
        container.style.display = 'none';
    }
};

// Make loadMLKeywords function globally accessible (legacy support)
window.loadMLKeywords = function() {
    console.log('loadMLKeywords called');
    const container = document.getElementById('mlKeywordsContainer');
    const keywordsDiv = document.getElementById('mlKeywords');
    
    console.log('Container:', container, 'KeywordsDiv:', keywordsDiv);
    
    if (container && container.style.display === 'none') {
        container.style.display = 'block';
        keywordsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading ML keywords...</p></div>';
        
        fetch('/api/ml-keywords')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    keywordsDiv.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                    return;
                }
                
                let keywordsList = '';
                if (data.keywords && data.keywords.length > 0) {
                    keywordsList = '<div class="mt-2"><h6>Sample Keywords:</h6><div class="row">';
                    data.keywords.slice(0, 20).forEach(keyword => {
                        const badgeClass = keyword.category === 'Business' ? 'success' : 
                                         keyword.category === 'Personal' ? 'warning' : 'danger';
                        keywordsList += `
                            <div class="col-6 mb-1">
                                <small class="d-flex justify-content-between">
                                    <span>${keyword.keyword}</span>
                                    <span class="badge bg-${badgeClass}">${keyword.risk_score}</span>
                                </small>
                            </div>
                        `;
                    });
                    keywordsList += '</div></div>';
                }
                
                keywordsDiv.innerHTML = `
                    <h6>ML Keywords Summary</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Keywords</span>
                            <span class="badge bg-primary">${data.total_keywords || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Business Keywords</span>
                            <span class="badge bg-success">${data.categories?.Business || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Personal Keywords</span>
                            <span class="badge bg-warning">${data.categories?.Personal || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Suspicious Keywords</span>
                            <span class="badge bg-danger">${data.categories?.Suspicious || 0}</span>
                        </li>
                    </ul>
                    ${keywordsList}
                    <div class="mt-2">
                        ${data.total_keywords > 0 ? 
                            `<div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-success" onclick="refreshMLKeywords()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="clearMLKeywords()">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </div>` : 
                            `<button class="btn btn-sm btn-outline-primary" onclick="populateDefaultKeywords()">
                                <i class="fas fa-plus"></i> Populate Default Keywords
                            </button>`
                        }
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading ML keywords:', error);
                keywordsDiv.innerHTML = '<div class="alert alert-danger">Failed to load ML keywords. Please try again.</div>';
            });
    } else if (container) {
        container.style.display = 'none';
    }
};

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up ML Keywords button');
    
    // Set up ML Keywords button with event listener as backup
    const mlKeywordsBtn = document.getElementById('mlKeywordsBtn');
    if (mlKeywordsBtn) {
        mlKeywordsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Button clicked via event listener');
            window.showMLKeywords();
        });
        console.log('ML Keywords button event listener added');
    }
    
    // Initialize charts if elements exist
    if (typeof initializeCharts === 'function') {
        initializeCharts();
    }
    
    // Load initial data if functions exist
    if (typeof loadWhitelistDomains === 'function') {
        loadWhitelistDomains();
    }
    if (typeof updatePerformanceMetrics === 'function') {
        updatePerformanceMetrics();
    }
    if (typeof updateSecurityMetrics === 'function') {
        updateSecurityMetrics();
    }
    if (typeof updateDataAnalytics === 'function') {
        updateDataAnalytics();
    }
    if (typeof updateSystemLogs === 'function') {
        updateSystemLogs();
    }
    
    // Set up periodic updates only if functions exist
    if (typeof updatePerformanceMetrics === 'function') {
        setInterval(updatePerformanceMetrics, 5000);  // Every 5 seconds
    }
    if (typeof updateSecurityMetrics === 'function') {
        setInterval(updateSecurityMetrics, 10000);    // Every 10 seconds
    }
    if (typeof updateDataAnalytics === 'function') {
        setInterval(updateDataAnalytics, 30000);      // Every 30 seconds
    }
    if (typeof updateSystemLogs === 'function') {
        setInterval(updateSystemLogs, 15000);         // Every 15 seconds
    }
    
    // Set up log filter listeners only if elements exist
    const logLevelFilter = document.getElementById('log-level-filter');
    const logComponentFilter = document.getElementById('log-component-filter');
    
    if (logLevelFilter && typeof updateSystemLogs === 'function') {
        logLevelFilter.addEventListener('change', updateSystemLogs);
    }
    if (logComponentFilter && typeof updateSystemLogs === 'function') {
        logComponentFilter.addEventListener('change', updateSystemLogs);
    }
});
</script>

{% endblock %}
