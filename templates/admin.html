{% extends "base.html" %}

{% block title %}Admin Panel - Email Guardian{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active">Admin Panel</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-cog text-primary me-2"></i>
                System Administration
            </h1>
            <div class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>
                System Online
            </div>
        </div>
    </div>
</div>

<!-- System Statistics -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_sessions }}</h4>
                        <p class="card-text">Total Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.active_sessions }}</h4>
                        <p class="card-text">Active Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-spinner fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.completed_sessions }}</h4>
                        <p class="card-text">Completed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.failed_sessions }}</h4>
                        <p class="card-text">Failed Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>
                    System Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="cleanupOldSessions()">
                        <i class="fas fa-broom me-2"></i>
                        Clean Old Sessions
                    </button>
                    <button class="btn btn-outline-warning" onclick="clearUploads()">
                        <i class="fas fa-trash me-2"></i>
                        Clear Upload Folder
                    </button>
                    <button class="btn btn-outline-info" onclick="exportSettings()">
                        <i class="fas fa-download me-2"></i>
                        Export Settings
                    </button>
                    <button class="btn btn-outline-success" onclick="testDatabase()">
                        <i class="fas fa-database me-2"></i>
                        Test Database
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="mb-3">
                        <label class="form-label">Max File Size (MB)</label>
                        <input type="number" class="form-control" value="16" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Session Timeout (hours)</label>
                        <input type="number" class="form-control" value="24" min="1" max="168">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">Debug Mode</label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>
                        Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Whitelist Management -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Whitelist Domains
                </h5>
            </div>
            <div class="card-body">
                <div id="whitelistDomains">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading whitelist domains...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Rules Management
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('rules') }}" class="btn btn-outline-primary">
                        <i class="fas fa-shield-virus me-2"></i>
                        Security Rules
                    </a>
                    <a href="{{ url_for('rules') }}" class="btn btn-outline-warning">
                        <i class="fas fa-filter me-2"></i>
                        Exclusion Rules
                    </a>
                    <a href="{{ url_for('wordlist_management') }}" class="btn btn-primary">
                        <i class="fas fa-list-alt me-2"></i>
                        Manage Wordlists
                    </a>
                    <a href="{{ url_for('admin_excluded_emails') }}" class="btn btn-danger">
                        <i class="fas fa-ban me-2"></i>
                        Excluded Emails
                    </a>
                </div>
                <div id="newMLKeywordsContainer" style="display: none;" class="mt-3">
                    <div id="newMLKeywords" class="card">
                        <div class="card-body">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading ML keywords...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="exclusionKeywordsContainer" style="display: none;" class="mt-3">
                    <div id="exclusionKeywords" class="card">
                        <div class="card-body">
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading exclusion keywords...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="manageWordlistsContainer" style="display: none;" class="mt-3">
                    <div id="manageWordlists" class="card">
                        <div class="card-body">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading wordlists...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keyword Editor Modal -->
                <div class="modal fade" id="keywordEditorModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit me-2"></i>ML Keywords Editor
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Single Keyword Tab -->
                                <ul class="nav nav-tabs" id="keywordTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-keyword" type="button">
                                            Single Keyword
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk-keywords" type="button">
                                            Bulk Import
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content mt-3" id="keywordTabContent">
                                    <!-- Single Keyword Tab -->
                                    <div class="tab-pane fade show active" id="single-keyword" role="tabpanel">
                                        <div class="mb-3">
                                            <label for="newKeywordText" class="form-label">Keyword</label>
                                            <input type="text" class="form-control" id="newKeywordText" placeholder="Enter keyword">
                                        </div>
                                        <div class="mb-3">
                                            <label for="newKeywordCategory" class="form-label">Category</label>
                                            <select class="form-select" id="newKeywordCategory">
                                                <option value="Business">Business</option>
                                                <option value="Personal">Personal</option>
                                                <option value="Suspicious">Suspicious</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newKeywordRisk" class="form-label">Risk Score (1-10)</label>
                                            <input type="number" class="form-control" id="newKeywordRisk" min="1" max="10" value="5">
                                        </div>
                                    </div>

                                    <!-- Bulk Keywords Tab -->
                                    <div class="tab-pane fade" id="bulk-keywords" role="tabpanel">
                                        <div class="mb-3">
                                            <label for="bulkKeywordsText" class="form-label">Keywords</label>
                                            <textarea class="form-control" id="bulkKeywordsText" rows="8" 
                                                placeholder="Enter multiple keywords, one per line or comma-separated:

confidential document
urgent payment
invoice attached
wire transfer, bank account, credit card
suspicious activity"></textarea>
                                            <div class="form-text">
                                                Enter keywords separated by new lines or commas. Mixed format is supported.
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="bulkKeywordCategory" class="form-label">Category (for all keywords)</label>
                                            <select class="form-select" id="bulkKeywordCategory">
                                                <option value="Business">Business</option>
                                                <option value="Personal">Personal</option>
                                                <option value="Suspicious">Suspicious</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="bulkKeywordRisk" class="form-label">Risk Score (1-10, for all keywords)</label>
                                            <input type="number" class="form-control" id="bulkKeywordRisk" min="1" max="10" value="5">
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            All keywords will be added with the same category and risk score. You can edit individual keywords after import.
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" onclick="addKeywords()">
                                        <i class="fas fa-plus"></i> Add Keywords
                                    </button>
                                </div>

                                <div id="keywordsList">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary"></div>
                                        <p class="mt-2">Loading keywords...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="saveAllKeywords()">
                                    <i class="fas fa-save me-1"></i>Save All Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Risk Scoring Algorithm Transparency -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain text-primary me-2"></i>
                    Risk Scoring Algorithm Transparency
                </h5>
                <p class="text-muted small mb-0">How the machine learning engine calculates risk scores</p>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Algorithm Overview -->
                    <div class="col-lg-6 mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-info-circle text-info me-2"></i>Algorithm Components
                        </h6>

                        <!-- Anomaly Detection -->
                        <div class="algorithm-component mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 text-primary">Anomaly Detection</h6>
                                <span class="badge bg-primary">{{ risk_scoring_info.algorithm_components.anomaly_detection.weight }}% Weight</span>
                            </div>
                            <p class="text-muted small mb-2">{{ risk_scoring_info.algorithm_components.anomaly_detection.description }}</p>
                            <div class="row text-sm">
                                <div class="col-6">
                                    <strong>Method:</strong> {{ risk_scoring_info.algorithm_components.anomaly_detection.method.split('.')[-1] }}
                                </div>
                                <div class="col-6">
                                    <strong>Estimators:</strong> {{ risk_scoring_info.algorithm_components.anomaly_detection.estimators }}
                                </div>
                                <div class="col-6 mt-1">
                                    <strong>Contamination:</strong> {{ risk_scoring_info.algorithm_components.anomaly_detection.contamination_rate }}
                                </div>
                            </div>
                        </div>

                        <!-- Rule-Based Factors -->
                        <div class="algorithm-component mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 text-success">Rule-Based Factors</h6>
                                <div>
                                    <span class="badge bg-success me-2">{{ risk_scoring_info.algorithm_components.rule_based_factors.weight }}% Weight</span>
                                    <button class="btn btn-sm btn-outline-success" onclick="toggleMLEditor()">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                </div>
                            </div>

                            <!-- Read-only view -->
                            <div id="ml-factors-view" class="rule-factors">
                                {% for factor in risk_scoring_info.algorithm_components.rule_based_factors.factors %}
                                <div class="d-flex justify-content-between py-3 border-bottom risk-factor-item" 
                                     style="cursor: pointer; border-radius: 4px; transition: all 0.2s; min-height: 120px;"
                                     data-factor-id="{{ factor.id if factor.id else '' }}"
                                     data-factor-name="{{ factor.name }}"
                                     data-factor-description="{{ factor.description }}"
                                     data-factor-max-score="{{ factor.max_score }}"
                                     data-factor-category="{{ factor.category if factor.category else 'General' }}"
                                     data-factor-weight="{{ factor.weight_percentage if factor.weight_percentage else 0.0 }}"
                                     onclick="viewRiskFactorSimple(this)"
                                     onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.transform='translateX(5px)'"
                                     onmouseout="this.style.backgroundColor='transparent'; this.style.transform='translateX(0)'">
                                    <div style="flex: 1;">
                                        <small class="fw-bold text-primary">{{ factor.name }}</small>
                                        <br><small class="text-muted">{{ factor.description }}</small>

                                        <!-- Implementation Details -->
                                        {% if factor.calculation_config %}
                                        <div class="mt-2 p-2 bg-white rounded border" style="font-size: 11px;">
                                            <strong class="text-info"><i class="fas fa-cogs me-1"></i>Implementation:</strong>
                                            <div class="mt-1">
                                                {% if factor.calculation_config.field %}
                                                    <span class="badge bg-light text-dark me-1">Field: <code>{{ factor.calculation_config.field }}</code></span>
                                                {% endif %}
                                                {% if factor.calculation_config.fields %}
                                                    <span class="badge bg-light text-dark me-1">Fields: 
                                                        {% for field in factor.calculation_config.fields %}
                                                            <code>{{ field }}</code>{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </span>
                                                {% endif %}
                                                {% if factor.calculation_config.trigger_values %}
                                                    <br><span class="badge bg-warning text-dark me-1">Triggers: {{ factor.calculation_config.trigger_values|join(', ') }}</span>
                                                {% endif %}
                                                {% if factor.calculation_config.patterns %}
                                                    <br><span class="badge bg-warning text-dark me-1">Patterns: {{ factor.calculation_config.patterns|join(', ') }}</span>
                                                {% endif %}
                                                {% if factor.calculation_config.suspicious_patterns %}
                                                    <br><span class="badge bg-danger text-light me-1">Suspicious: {{ factor.calculation_config.suspicious_patterns|join(', ') }}</span>
                                                {% endif %}
                                                {% if factor.calculation_config.risk_periods %}
                                                    <br><span class="badge bg-info text-light me-1">Risk Periods: {{ factor.calculation_config.risk_periods|join(', ') }}</span>
                                                {% endif %}
                                                {% if factor.calculation_config.score_calculation %}
                                                    <br><span class="badge bg-secondary text-light me-1">Method: {{ factor.calculation_config.score_calculation }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="mt-2 p-2 bg-light rounded" style="font-size: 11px;">
                                            <span class="text-muted"><i class="fas fa-info-circle me-1"></i>No implementation details configured</span>
                                        </div>
                                        {% endif %}

                                        {% if factor.category %}
                                        <div class="mt-2">
                                            <span class="badge badge-sm 
                                                {% if factor.category == 'Security' %}bg-danger
                                                {% elif factor.category == 'Content' %}bg-warning  
                                                {% elif factor.category == 'Time' %}bg-info
                                                {% else %}bg-secondary{% endif %}">{{ factor.category }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <small class="fw-bold">Max: {{ "%.1f"|format(factor.max_score) }}</small>
                                        {% if factor.weight_percentage %}
                                        <br><small class="text-muted">{{ "%.1f"|format(factor.weight_percentage) }}%</small>
                                        {% endif %}
                                        <br><i class="fas fa-chevron-right text-muted" style="font-size: 10px;"></i>
                                    </div>

                                    <!-- Hidden calculation config data -->
                                    <script type="application/json" class="risk-factor-config" data-factor-id="{{ factor.id }}">
                                        {{ factor.calculation_config|tojson if factor.calculation_config else '{}' }}
                                    </script>
                                </div>
                                {% endfor %}

                                <!-- Add New Factor Button -->
                                <div class="d-flex justify-content-center mt-3">
                                    <button class="btn btn-sm btn-outline-success" onclick="showAddRiskFactorModal()">
                                        <i class="fas fa-plus me-1"></i>Add New Risk Factor
                                    </button>
                                    {% if not risk_scoring_info.algorithm_components.rule_based_factors.factors or risk_scoring_info.algorithm_components.rule_based_factors.factors|length == 0 or risk_scoring_info.algorithm_components.rule_based_factors.factors[0].id is none %}
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="populateDefaultRiskFactors()">
                                        <i class="fas fa-download me-1"></i>Load Defaults
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Editable view -->
                            <div id="ml-factors-editor" style="display: none;">
                                <div class="mb-3">
                                    <h6 class="text-primary">Edit ML Risk Factors</h6>
                                    <small class="text-muted">Adjust maximum risk scores for each factor (0.0 - 1.0)</small>
                                </div>

                                <div id="ml-factor-inputs">
                                    {% for factor in risk_scoring_info.algorithm_components.rule_based_factors.factors %}
                                    <div class="row mb-2 align-items-center">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">{{ factor.name }}</label>
                                            <small class="d-block text-muted">{{ factor.description }}</small>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" 
                                                   class="form-control form-control-sm ml-factor-input" 
                                                   data-factor="{{ factor.name.lower().replace(' ', '_') }}"
                                                   value="{{ "%.1f"|format(factor.max_score) }}" 
                                                   min="0.0" 
                                                   max="1.0" 
                                                   step="0.1">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-sm btn-outline-danger" onclick="removeMLFactor(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <button class="btn btn-sm btn-outline-primary" onclick="addMLFactor()">
                                            <i class="fas fa-plus me-1"></i>Add New Factor
                                        </button>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="saveMLConfiguration()">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="cancelMLEdit()">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="resetMLDefaults()">
                                        <i class="fas fa-undo me-1"></i>Reset to Defaults
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Thresholds & Attachment Scoring -->
                    <div class="col-lg-6 mb-4">
                        <!-- Risk Level Thresholds -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">
                                <i class="fas fa-chart-line text-warning me-2"></i>Risk Level Thresholds
                            </h6>
                            <button class="btn btn-sm btn-outline-warning" onclick="toggleThresholdEditor()">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                        </div>

                        <!-- Read-only threshold view -->
                        <div id="thresholds-view" class="risk-thresholds mb-4">
                            {% for level, threshold in risk_scoring_info.thresholds.items() %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="d-flex align-items-center">
                                    {% if level == 'critical' %}
                                        <div class="badge bg-danger me-2">Critical</div>
                                    {% elif level == 'high' %}
                                        <div class="badge bg-warning me-2">High</div>
                                    {% elif level == 'medium' %}
                                        <div class="badge bg-info me-2">Medium</div>
                                    {% else %}
                                        <div class="badge bg-secondary me-2">Low</div>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <strong>≥ {{ threshold }}</strong>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Editable threshold view -->
                        <div id="thresholds-editor" style="display: none;" class="mb-4">
                            <div class="mb-3">
                                <h6 class="text-warning">Edit Risk Thresholds</h6>
                                <small class="text-muted">Set minimum scores for each risk level (0.0 - 1.0)</small>
                            </div>

                            <div id="threshold-inputs">
                                {% for level, threshold in risk_scoring_info.thresholds.items() %}
                                <div class="row mb-2 align-items-center">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            {% if level == 'critical' %}
                                                <div class="badge bg-danger me-2">Critical</div>
                                            {% elif level == 'high' %}
                                                <div class="badge bg-warning me-2">High</div>
                                            {% elif level == 'medium' %}
                                                <div class="badge bg-info me-2">Medium</div>
                                            {% else %}
                                                <div class="badge bg-secondary me-2">Low</div>
                                            {% endif %}
                                            <span class="small">{{ level.title() }} Risk</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="number" 
                                               class="form-control form-control-sm threshold-input" 
                                               data-level="{{ level }}"
                                               value="{{ threshold }}" 
                                               min="0.0" 
                                               max="1.0" 
                                               step="0.1"
                                               placeholder="≥ threshold">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-warning" onclick="saveThresholds()">
                                    <i class="fas fa-save me-1"></i>Save Thresholds
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelThresholdEdit()">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </div>

                        <!-- Attachment Risk Scoring -->
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-paperclip text-danger me-2"></i>Attachment Risk Scoring
                        </h6>
                        <div class="attachment-scoring">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="fw-bold text-danger">High Risk Extensions</small>
                                    <small class="fw-bold">+{{ risk_scoring_info.attachment_scoring.high_risk_score }}</small>
                                </div>
                                <div class="extension-list">
                                    {% for ext in risk_scoring_info.attachment_scoring.high_risk_extensions %}
                                        <span class="badge bg-danger me-1">{{ ext }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="fw-bold text-warning">Medium Risk Extensions</small>
                                    <small class="fw-bold">+{{ risk_scoring_info.attachment_scoring.medium_risk_score }}</small>
                                </div>
                                <div class="extension-list">
                                    {% for ext in risk_scoring_info.attachment_scoring.medium_risk_extensions %}
                                        <span class="badge bg-warning me-1">{{ ext }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="fw-bold text-info">Suspicious Patterns</small>
                                    <small class="fw-bold">+{{ risk_scoring_info.attachment_scoring.pattern_score }}</small>
                                </div>
                                <div class="pattern-list">
                                    {% for pattern in risk_scoring_info.attachment_scoring.suspicious_patterns %}
                                        <span class="badge bg-info me-1">{{ pattern }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Configuration -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-tachometer-alt text-secondary me-2"></i>Performance Configuration
                        </h6>
                        <div class="row">
                            <div class="col-md-2">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-{{ 'success' if risk_scoring_info.performance_config.fast_mode else 'secondary' }}">
                                        {{ 'ON' if risk_scoring_info.performance_config.fast_mode else 'OFF' }}
                                    </div>
                                    <small class="text-muted">Fast Mode</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-primary">{{ risk_scoring_info.performance_config.max_ml_records }}</div>
                                    <small class="text-muted">Max Records</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-info">{{ risk_scoring_info.performance_config.ml_estimators }}</div>
                                    <small class="text-muted">ML Estimators</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-warning">{{ risk_scoring_info.performance_config.tfidf_max_features }}</div>
                                    <small class="text-muted">TF-IDF Features</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="fw-bold text-success">{{ risk_scoring_info.performance_config.chunk_size }}</div>
                                    <small class="text-muted">Chunk Size</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Performance Monitoring -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt text-success me-2"></i>
                    System Performance Monitor
                </h5>
                <p class="text-muted small mb-0">Real-time system resource utilization and processing metrics</p>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" id="cpu-progress" style="width: 0%"></div>
                                </div>
                                <h6 class="mb-1" id="cpu-usage">0%</h6>
                                <small class="text-muted">CPU Usage</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-info" id="memory-progress" style="width: 0%"></div>
                                </div>
                                <h6 class="mb-1" id="memory-usage">0%</h6>
                                <small class="text-muted">Memory Usage</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="mb-1" id="active-threads">0</h6>
                                <small class="text-muted">Active Threads</small>
                                <div class="mt-1">
                                    <span class="badge bg-primary" id="processing-threads">0 Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="mb-1" id="avg-response-time">0ms</h6>
                                <small class="text-muted">Avg Response Time</small>
                                <div class="mt-1">
                                    <span class="badge bg-warning" id="slow-requests">0 Slow</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <canvas id="performance-chart" width="400" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security Alerts & Insights -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt text-danger me-2"></i>
                    Security Alert Dashboard
                </h5>
                <p class="text-muted small mb-0">Real-time threat detection and security insights</p>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-2 bg-danger bg-opacity-10 rounded">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <div>
                                <div class="fw-bold text-danger" id="critical-threats">0</div>
                                <small class="text-muted">Critical Threats</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-2 bg-warning bg-opacity-10 rounded">
                            <i class="fas fa-eye text-warning me-2"></i>
                            <div>
                                <div class="fw-bold text-warning" id="suspicious-activities">0</div>
                                <small class="text-muted">Suspicious Activities</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-2 bg-info bg-opacity-10 rounded">
                            <i class="fas fa-ban text-info me-2"></i>
                            <div>
                                <div class="fw-bold text-info" id="blocked-domains">0</div>
                                <small class="text-muted">Blocked Domains</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Security Events -->
                <div class="security-events" style="max-height: 300px; overflow-y: auto;">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-clock me-1"></i>Recent Security Events
                    </h6>
                    <div id="security-events-list">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading security events...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie text-primary me-2"></i>
                    Threat Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="threat-distribution-chart" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Analytics & Insights -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-info me-2"></i>
                    Data Analytics & Processing Insights
                </h5>
                <p class="text-muted small mb-0">Comprehensive analysis of processed email data and patterns</p>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-primary" id="total-emails-processed">0</div>
                            <small class="text-muted">Total Emails Processed</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-success" id="clean-emails">0</div>
                            <small class="text-muted">Clean Emails</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-warning" id="flagged-emails">0</div>
                            <small class="text-muted">Flagged Emails</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-danger" id="high-risk-emails">0</div>
                            <small class="text-muted">High Risk</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-info" id="unique-domains">0</div>
                            <small class="text-muted">Unique Domains</small>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-secondary" id="avg-processing-time">0s</div>
                            <small class="text-muted">Avg Processing Time</small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Email Volume Trends</h6>
                        <canvas id="email-volume-chart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Risk Level Distribution</h6>
                        <canvas id="risk-level-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced System Management -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs text-secondary me-2"></i>
                    Advanced System Management
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6 class="fw-bold">Database Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info" onclick="optimizeDatabase()">
                                <i class="fas fa-database me-2"></i>Optimize Database
                            </button>
                            <button class="btn btn-outline-warning" onclick="rebuildIndexes()">
                                <i class="fas fa-wrench me-2"></i>Rebuild Indexes
                            </button>
                            <button class="btn btn-outline-primary" onclick="backupDatabase()">
                                <i class="fas fa-save me-2"></i>Create Backup
                            </button>
                        </div>
                    </div>
                    <div class="col-12">
                        <h6 class="fw-bold">ML Model Management</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success" onclick="retrainModels()">
                                <i class="fas fa-brain me-2"></i>Retrain Models
                            </button>
                            <button class="btn btn-outline-info" onclick="updateMLKeywords()">
                                <i class="fas fa-tags me-2"></i>Update Keywords
                            </button>
                            <button class="btn btn-outline-warning" onclick="validateModels()">
                                <i class="fas fa-check-circle me-2"></i>Validate Models
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download text-primary me-2"></i>
                    Export & Reporting
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="fw-bold">System Reports</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="exportSystemReport()">
                            <i class="fas fa-file-alt me-2"></i>System Health Report
                        </button>
                        <button class="btn btn-outline-info" onclick="exportSecurityReport()">
                            <i class="fas fa-shield-alt me-2"></i>Security Analysis Report
                        </button>
                        <button class="btn btn-outline-success" onclick="exportPerformanceReport()">
                            <i class="fas fa-tachometer-alt me-2"></i>Performance Report
                        </button>
                    </div>
                </div>
                <div>
                    <h6 class="fw-bold">Data Export</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-warning" onclick="exportAllSessions()">
                            <i class="fas fa-database me-2"></i>Export All Sessions
                        </button>
                        <button class="btn btn-outline-secondary" onclick="exportConfiguration()">
                            <i class="fas fa-cog me-2"></i>Export Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Logs & Debugging -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-alt text-warning me-2"></i>
                            System Logs & Debugging
                        </h5>
                        <p class="text-muted small mb-0">Real-time system logs and debugging information</p>
                    </div>
                    <div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="clearLogs()">
                                <i class="fas fa-trash me-1"></i>Clear
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="downloadLogs()">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="log-level-filter">
                            <option value="all">All Levels</option>
                            <option value="error">Errors Only</option>
                            <option value="warning">Warnings</option>
                            <option value="info">Info</option>
                            <option value="debug">Debug</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="log-component-filter">
                            <option value="all">All Components</option>
                            <option value="ml_engine">ML Engine</option>
                            <option value="data_processor">Data Processor</option>
                            <option value="rule_engine">Rule Engine</option>
                            <option value="session_manager">Session Manager</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="auto-refresh-logs" checked>
                            <label class="form-check-label" for="auto-refresh-logs">Auto Refresh</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="follow-logs" checked>
                            <label class="form-check-label" for="follow-logs">Follow Logs</label>
                        </div>
                    </div>
                </div>
                <div class="log-container" style="height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; font-family: monospace; font-size: 12px;">
                    <div id="system-logs">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading system logs...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Sessions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Sessions
                </h5>
            </div>
            <div class="card-body">
                {% if recent_sessions %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Filename</th>
                                <th>Upload Time</th>
                                <th>Status</th>
                                <th>Records</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>
                                    <code>{{ session.id[:8] }}...</code>
                                </td>
                                <td>{{ session.filename }}</td>
                                <td>{{ session.upload_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if session.status == 'completed' %}
                                        <span class="badge bg-success">{{ session.status }}</span>
                                    {% elif session.status == 'processing' %}
                                        <span class="badge bg-warning">{{ session.status }}</span>
                                    {% elif session.status == 'failed' %}
                                        <span class="badge bg-danger">{{ session.status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ session.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ session.total_records or 0 }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('dashboard', session_id=session.id) }}" 
                                           class="btn btn-outline-primary" title="View Dashboard">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteSession('{{ session.id }}')" 
                                                title="Delete Session">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No sessions found</h5>
                    <p class="text-muted">Upload some files to see session data here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function cleanupOldSessions() {
    if (confirm('This will remove sessions older than 7 days. Continue?')) {
        showAlert('Old sessions cleaned successfully!', 'success');
    }
}

function clearUploads() {
    if (confirm('This will delete all uploaded files. Continue?')) {
        showAlert('Upload folder cleared successfully!', 'success');
    }
}

function exportSettings() {
    showAlert('Settings exported to downloads folder!', 'info');
}

function testDatabase() {
    showAlert('Database connection test successful!', 'success');
}

function saveConfig() {
    showAlert('Configuration saved successfully!', 'success');
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session? This action cannot be undone and will remove all associated data.')) {
        const deleteButton = document.querySelector(`button[onclick="deleteSession('${sessionId}')"]`);
        if (deleteButton) {
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        fetch(`/admin/session/${sessionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'deleted') {
                showSuccess(data.message || 'Session deleted successfully');
                setTimeout(() => location.reload(), 1000);
            } else if (data.error) {
                showError('Error: ' + data.error);
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                }
            } else {
                showError('Unknown error occurred while deleting session');
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Network error: ' + error.message);
            if (deleteButton) {
                deleteButton.disabled = false;
                deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            }
        });
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}



function loadWhitelistDomains() {
    const container = document.getElementById('whitelistDomains');
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading whitelist domains...</p></div>';

    fetch('/api/whitelist-domains')
        .then(response => response.json())
        .then(domains => {
            if (domains.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-shield-alt fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No whitelist domains found</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAddDomainForm()">
                            <i class="fas fa-plus"></i> Add Domain
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Whitelist Domains (${domains.length})</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showAddDomainForm()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            domains.forEach(domain => {
                html += `
                    <tr>
                        <td><code>${domain.domain}</code></td>
                        <td><span class="badge bg-secondary">${domain.domain_type}</span></td>
                        <td>
                            <span class="badge bg-${domain.is_active ? 'success' : 'warning'}">
                                ${domain.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-${domain.is_active ? 'warning' : 'success'}" 
                                        onclick="toggleDomainStatus(${domain.id})" 
                                        title="${domain.is_active ? 'Deactivate' : 'Activate'}">
                                    <i class="fas fa-${domain.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteDomain(${domain.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading whitelist domains:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-3">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Failed to load whitelist domains</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadWhitelistDomains()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        });
}

function showAddDomainForm() {
    const domain = prompt('Enter domain to add to whitelist:');
    if (domain && domain.trim()) {
        addDomainToWhitelist(domain.trim());
    }
}

function addDomainToWhitelist(domain) {
    fetch('/api/whitelist-domains', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            domain: domain,
            domain_type: 'Corporate',
            added_by: 'Admin'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error adding domain:', error);
        showError('Failed to add domain to whitelist');
    });
}

function toggleDomainStatus(domainId) {
    fetch(`/api/whitelist-domains/${domainId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error toggling domain status:', error);
        showError('Failed to update domain status');
    });
}

function deleteDomain(domainId) {
    if (confirm('Are you sure you want to delete this whitelist domain?')) {
        fetch(`/api/whitelist-domains/${domainId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                loadWhitelistDomains();
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting domain:', error);
            showError('Failed to delete domain');
        });
    }
}

// ML Configuration Editor Functions
let currentMLConfig = {};

function toggleMLEditor() {
    const viewDiv = document.getElementById('ml-factors-view');
    const editorDiv = document.getElementById('ml-factors-editor');

    if (editorDiv.style.display === 'none') {
        viewDiv.style.display = 'none';
        editorDiv.style.display = 'block';
    } else {
        viewDiv.style.display = 'block';
        editorDiv.style.display = 'none';
    }
}

function saveMLConfiguration() {
    const factors = [];
    document.querySelectorAll('.ml-factor-input').forEach(input => {
        factors.push({
            name: input.dataset.factor,
            max_score: parseFloat(input.value)
        });
    });

    fetch('/admin/ml-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ factors })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ML configuration saved successfully');
            location.reload();
        } else {
            showError('Failed to save ML configuration: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving ML config:', error);
        showError('Failed to save ML configuration');
    });
}

function cancelMLEdit() {
    toggleMLEditor();
}

function resetMLDefaults() {
    if (confirm('Reset all ML factors to default values?')) {
        fetch('/admin/ml-config/reset', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('ML configuration reset to defaults');
                location.reload();
            } else {
                showError('Failed to reset ML configuration');
            }
        });
    }
}

// Performance monitoring functions
let performanceChart;
let threatDistributionChart;
let emailVolumeChart;
let riskLevelChart;

function initializeCharts() {
    // Performance Chart
    const performanceCtx = document.getElementById('performance-chart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU %',
                borderColor: '#28a745',
                data: [],
                fill: false
            }, {
                label: 'Memory %',
                borderColor: '#17a2b8',
                data: [],
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });

    // Threat Distribution Chart
    const threatCtx = document.getElementById('threat-distribution-chart').getContext('2d');
    threatDistributionChart = new Chart(threatCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High Risk', 'Medium Risk', 'Low Risk'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Email Volume Chart
    const emailVolumeCtx = document.getElementById('email-volume-chart').getContext('2d');
    emailVolumeChart = new Chart(emailVolumeCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Emails Processed',
                backgroundColor: '#007bff',
                data: []
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Risk Level Chart
    const riskLevelCtx = document.getElementById('risk-level-chart').getContext('2d');
    riskLevelChart = new Chart(riskLevelCtx, {
        type: 'pie',
        data: {
            labels: ['Clean', 'Flagged', 'High Risk'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function updatePerformanceMetrics() {
    fetch('/admin/api/performance-metrics')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Update performance indicators with null checks
        const cpuElement = document.getElementById('cpu-usage');
        const memoryElement = document.getElementById('memory-usage');
        const threadsElement = document.getElementById('active-threads');
        const processingElement = document.getElementById('processing-threads');
        const responseElement = document.getElementById('avg-response-time');
        const slowElement = document.getElementById('slow-requests');

        if (cpuElement) {
            cpuElement.textContent = data.cpu_usage + '%';
            const cpuProgress = document.getElementById('cpu-progress');
            if (cpuProgress) cpuProgress.style.width = data.cpu_usage + '%';
        }

        if (memoryElement) {
            memoryElement.textContent = data.memory_usage + '%';
            const memoryProgress = document.getElementById('memory-progress');
            if (memoryProgress) memoryProgress.style.width = data.memory_usage + '%';
        }

        if (threadsElement) threadsElement.textContent = data.active_threads;
        if (processingElement) processingElement.textContent = data.processing_threads + ' Processing';
        if (responseElement) responseElement.textContent = data.avg_response_time + 'ms';
        if (slowElement) slowElement.textContent = data.slow_requests + ' Slow';

        // Update performance chart only if it exists
        if (typeof performanceChart !== 'undefined' && performanceChart) {
            const now = new Date().toLocaleTimeString();
            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push(data.cpu_usage);
            performanceChart.data.datasets[1].data.push(data.memory_usage);

            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
            }

            performanceChart.update();
        }
    })
    .catch(error => {
        // Silently handle errors for background updates to avoid console spam
    });
}

function updateSecurityMetrics() {
    fetch('/admin/api/security-metrics')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const criticalElement = document.getElementById('critical-threats');        const suspiciousElement = document.getElementById('suspicious-activities');
        const blockedElement = document.getElementById('blocked-domains');

        if (criticalElement) criticalElement.textContent = data.critical_threats;
        if (suspiciousElement) suspiciousElement.textContent = data.suspicious_activities;
        if (blockedElement) blockedElement.textContent = data.blocked_domains;

        // Update threat distribution chart only if it exists
        if (typeof threatDistributionChart !== 'undefined' && threatDistributionChart) {
            threatDistributionChart.data.datasets[0].data = [
                data.threat_distribution.critical,
                data.threat_distribution.high,
                data.threat_distribution.medium,
                data.threat_distribution.low
            ];
            threatDistributionChart.update();
        }

        // Update security events
        updateSecurityEvents(data.recent_events);
    })
    .catch(error => {
        // Silently handle errors for background updates
    });
}

function updateSecurityEvents(events) {
    const container = document.getElementById('security-events-list');
    if (!events || events.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">No recent security events</div>';
        return;
    }

    let html = '';
    events.forEach(event => {
        const timeAgo = getTimeAgo(new Date(event.timestamp));
        const iconClass = event.severity === 'critical' ? 'fa-exclamation-triangle text-danger' :
                         event.severity === 'warning' ? 'fa-eye text-warning' : 'fa-info-circle text-info';

        html += `
            <div class="d-flex align-items-start mb-2 p-2 bg-light rounded">
                <i class="fas ${iconClass} me-2 mt-1"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${event.title}</div>
                    <small class="text-muted">${event.description}</small>
                    <div class="text-muted small">${timeAgo}</div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function updateDataAnalytics() {
    fetch('/admin/api/data-analytics')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const totalElement = document.getElementById('total-emails-processed');
        const cleanElement = document.getElementById('clean-emails');
        const flaggedElement = document.getElementById('flagged-emails');
        const highRiskElement = document.getElementById('high-risk-emails');
        const domainsElement = document.getElementById('unique-domains');
        const timeElement = document.getElementById('avg-processing-time');

        if (totalElement) totalElement.textContent = data.total_emails.toLocaleString();
        if (cleanElement) cleanElement.textContent = data.clean_emails.toLocaleString();
        if (flaggedElement) flaggedElement.textContent = data.flagged_emails.toLocaleString();
        if (highRiskElement) highRiskElement.textContent = data.high_risk_emails.toLocaleString();
        if (domainsElement) domainsElement.textContent = data.unique_domains.toLocaleString();
        if (timeElement) timeElement.textContent = data.avg_processing_time + 's';

        // Update charts only if they exist
        if (typeof emailVolumeChart !== 'undefined' && emailVolumeChart) {
            emailVolumeChart.data.labels = data.volume_trends.labels;
            emailVolumeChart.data.datasets[0].data = data.volume_trends.data;
            emailVolumeChart.update();
        }

        if (typeof riskLevelChart !== 'undefined' && riskLevelChart) {
            riskLevelChart.data.datasets[0].data = [
                data.clean_emails,
                data.flagged_emails,
                data.high_risk_emails
            ];
            riskLevelChart.update();
        }
    })
    .catch(error => {
        // Silently handle errors for background updates
    });
}

function updateSystemLogs() {
    if (!document.getElementById('auto-refresh-logs').checked) return;

    const level = document.getElementById('log-level-filter').value;
    const component = document.getElementById('log-component-filter').value;

    fetch(`/admin/api/system-logs?level=${level}&component=${component}`)
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('system-logs');
        if (!data.logs || data.logs.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">No logs found</div>';
            return;
        }

        let html = '';
        data.logs.forEach(log => {
            const levelClass = log.level === 'ERROR' ? 'text-danger' :
                              log.level === 'WARNING' ? 'text-warning' :
                              log.level === 'INFO' ? 'text-info' : 'text-muted';

            html += `
                <div class="log-entry mb-1">
                    <span class="text-muted">[${log.timestamp}]</span>
                    <span class="${levelClass} fw-bold">[${log.level}]</span>
                    <span class="text-primary">[${log.component}]</span>
                    <span>${log.message}</span>
                </div>
            `;
        });

        container.innerHTML = html;

        // Auto-scroll to bottom if follow logs is enabled
        if (document.getElementById('follow-logs').checked) {
            container.scrollTop = container.scrollHeight;
        }
    })
    .catch(error => console.error('Error updating system logs:', error));
}

// Advanced system management functions
function optimizeDatabase() {
    if (confirm('This will optimize the database. Continue?')) {
        fetch('/admin/api/optimize-database', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Database optimized successfully');
            } else {
                showError('Failed to optimize database: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error optimizing database:', error);
            showError('Failed to optimize database');
        });
    }
}

function rebuildIndexes() {
    if (confirm('This will rebuild database indexes. Continue?')) {
        fetch('/admin/api/rebuild-indexes', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Database indexesrebuilt successfully');
            } else {
                showError('Failed to rebuild indexes: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error rebuilding indexes:', error);
            showError('Failed to rebuild indexes');
        });
    }
}

function backupDatabase() {
    fetch('/admin/api/backup-database', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Database backup created: ' + data.filename);
        } else {
            showError('Failed to create backup: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating backup:', error);
        showError('Failed to create database backup');
    });
}

function retrainModels() {
    if (confirm('This will retrain ML models using current data. This may take several minutes. Continue?')) {
        fetch('/admin/api/retrain-models', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('ML models retrained successfully');
            } else {
                showError('Failed to retrain models: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error retraining models:', error);
            showError('Failed to retrain ML models');
        });
    }
}

function updateMLKeywords() {
    fetch('/admin/api/update-ml-keywords', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ML keywords updated successfully');
        } else {
            showError('Failed to update keywords: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating ML keywords:', error);
        showError('Failed to update ML keywords');
    });
}

function validateModels() {
    fetch('/admin/api/validate-models', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ML models validation completed. Score: ' + data.validation_score);
        } else {
            showError('Failed to validate models: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error validating models:', error);
        showError('Failed to validate ML models');
    });
}

// Export functions
function exportSystemReport() {
    window.open('/admin/export/system-report', '_blank');
}

function exportSecurityReport() {
    window.open('/admin/export/security-report', '_blank');
}

function exportPerformanceReport() {
    window.open('/admin/export/performance-report', '_blank');
}

function exportAllSessions() {
    window.open('/admin/export/all-sessions', '_blank');
}

function exportConfiguration() {
    window.open('/admin/export/configuration', '_blank');
}

// Log management functions
function refreshLogs() {
    updateSystemLogs();
    showSuccess('Logs refreshed');
}

function populateDefaultKeywords() {
    if (confirm('This will add default ML keywords to the database. Continue?')) {
        fetch('/admin/keywords/populate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess(data.message);
                loadMLKeywords(); // Refresh the keywords display
            } else if (data.status === 'info') {
                showSuccess(data.message);
                loadMLKeywords(); // Refresh the keywords display
            } else {
                showError('Failed to populate keywords: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error populating keywords:', error);
            showError('Failed to populate keywords');
        });
    }
}

function refreshMLKeywords() {
    loadMLKeywords();
    showSuccess('ML keywords refreshed');
}

function clearMLKeywords() {
    if (confirm('This will delete ALL ML keywords from the database. This action cannot be undone. Continue?')) {
        fetch('/api/ml-keywords', { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('All ML keywords cleared');
                loadMLKeywords(); // Refresh the keywords display
            } else {
                showError('Failed to clear keywords: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error clearing keywords:', error);
            showError('Failed to clear keywords');
        });
    }
}

function clearLogs() {
    if (confirm('This will clear all system logs. Continue?')) {
        fetch('/admin/api/clear-logs', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('System logs cleared');
                updateSystemLogs();
            } else {
                showError('Failed to clear logs: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error clearing logs:', error);
            showError('Failed to clear logs');
        });
    }
}

function downloadLogs() {
    window.open('/admin/api/download-logs', '_blank');
}

// Utility functions
function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
    };

    for (let interval in intervals) {
        const count = Math.floor(seconds / intervals[interval]);
        if (count > 0) {
            return count === 1 ? `1 ${interval} ago` : `${count} ${interval}s ago`;
        }
    }
    return 'Just now';
}

// Simple ML Keywords function
window.showMLKeywords = function() {
    console.log('showMLKeywords called from button click');
    const container = document.getElementById('mlKeywordsContainer');
    const keywordsDiv = document.getElementById('mlKeywords');

    if (!container || !keywordsDiv) {
        console.error('Could not find container elements');
        alert('Error: Could not find ML Keywords container elements');
        return;
    }

    // Toggle visibility
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        keywordsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Loading ML keywords...</p></div>';

        // Fetch data
        fetch('/api/ml-keywords')
            .then(response => {
                console.log('API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ML Keywords data:', data);
                keywordsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-brain me-2"></i>ML Keywords Summary</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Keywords:</strong> ${data.total_keywords || 0}
                            </div>
                            <div class="col-6">
                                <strong>Last Updated:</strong> ${new Date(data.last_updated).toLocaleDateString()}
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-4">
                                <span class="badge bg-success me-2">${data.categories?.Business || 0}</span>
                                Business Keywords
                            </div>
                            <div class="col-4">
                                <span class="badge bg-warning me-2">${data.categories?.Personal || 0}</span>
                                Personal Keywords
                            </div>
                            <div class="col-4">
                                <span class="badge bg-danger me-2">${data.categories?.Suspicious || 0}</span>
                                Suspicious Keywords
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="window.populateDefaultKeywords()">
                                <i class="fas fa-plus me-1"></i>Populate Default
                            </button>
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="window.showMLKeywords()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading ML keywords:', error);
                keywordsDiv.innerHTML = '<div class="alert alert-danger">Error loading ML keywords: ' + error.message + '</div>';
            });
    } else {
        container.style.display = 'none';
    }
};

// Make loadMLKeywords function globally accessible (legacy support)
window.loadMLKeywords = function() {
    console.log('loadMLKeywords called');
    const container = document.getElementById('mlKeywordsContainer');
    const keywordsDiv = document.getElementById('mlKeywords');

    console.log('Container:', container, 'KeywordsDiv:', keywordsDiv);

    if (container && container.style.display === 'none') {
        container.style.display = 'block';
        keywordsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading ML keywords...</p></div>';

        fetch('/api/ml-keywords')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    keywordsDiv.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                    return;
                }

                let keywordsList = '';
                if (data.keywords && data.keywords.length > 0) {
                    keywordsList = '<div class="mt-2"><h6>Sample Keywords:</h6><div class="row">';
                    data.keywords.slice(0, 20).forEach(keyword => {
                        const badgeClass = keyword.category === 'Business' ? 'success' : 
                                         keyword.category === 'Personal' ? 'warning' : 'danger';
                        keywordsList += `
                            <div class="col-6 mb-1">
                                <small class="d-flex justify-content-between">
                                    <span>${keyword.keyword}</span>
                                    <span class="badge bg-${badgeClass}">${keyword.risk_score}</span>
                                </small>
                            </div>
                        `;
                    });
                    keywordsList += '</div></div>';
                }

                keywordsDiv.innerHTML = `
                    <h6>ML Keywords Summary</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Keywords</span>
                            <span class="badge bg-primary">${data.total_keywords || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Business Keywords</span>
                            <span class="badge bg-success">${data.categories?.Business || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Personal Keywords</span>
                            <span class="badge bg-warning">${data.categories?.Personal || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Suspicious Keywords</span>
                            <span class="badge bg-danger">${data.categories?.Suspicious || 0}</span>
                        </li>
                    </ul>
                    ${keywordsList}
                    <div class="mt-2">
                        ${data.total_keywords > 0 ? 
                            `<div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-success" onclick="refreshMLKeywords()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="clearMLKeywords()">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </div>` : 
                            `<button class="btn btn-sm btn-outline-primary" onclick="populateDefaultKeywords()">
                                <i class="fas fa-plus"></i> Populate Default Keywords
                            </button>`
                        }
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading ML keywords:', error);
                keywordsDiv.innerHTML = '<div class="alert alert-danger">Failed to load ML keywords. Please try again.</div>';
            });
    } else if (container) {
        container.style.display = 'none';
    }
};

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up all admin buttons...');

    // Set up the NEW ML Keywords button
    console.log('Looking for newMLKeywordsBtn...');
    const newMLKeywordsBtn = document.getElementById('newMLKeywordsBtn');
    if (newMLKeywordsBtn) {
        newMLKeywordsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('NEW ML Keywords button clicked!');
            toggleNewMLKeywords();
        });
        console.log('NEW ML Keywords button event listener added successfully');
    } else {
        console.error('Could not find newMLKeywordsBtn element');
    }

    // Set up the Exclusion Keywords button
    console.log('Looking for exclusionKeywordsBtn...');
    const exclusionKeywordsBtn = document.getElementById('exclusionKeywordsBtn');
    if (exclusionKeywordsBtn) {
        exclusionKeywordsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Exclusion Keywords button clicked!');
            toggleExclusionKeywords();
        });
        console.log('Exclusion Keywords button event listener added successfully');
    } else {
        console.error('Could not find exclusionKeywordsBtn element');
    }

    // Set up the Manage Wordlists button
    console.log('Looking for manageWordlistsBtn...');
    const manageWordlistsBtn = document.getElementById('manageWordlistsBtn');
    if (manageWordlistsBtn) {
        manageWordlistsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Manage Wordlists button clicked!');
            toggleManageWordlists();
        });
        console.log('Manage Wordlists button event listener added successfully');
    } else {
        console.error('Could not find manageWordlistsBtn element');
    }

    // Initialize charts if elements exist
    if (typeof initializeCharts === 'function') {
        initializeCharts();
    }

    // Load initial data if functions exist
    if (typeof loadWhitelistDomains === 'function') {
        loadWhitelistDomains();
    }
    if (typeof updatePerformanceMetrics === 'function') {
        updatePerformanceMetrics();
    }
    if (typeof updateSecurityMetrics === 'function') {
        updateSecurityMetrics();
    }
    if (typeof updateDataAnalytics === 'function') {
        updateDataAnalytics();
    }
    if (typeof updateSystemLogs === 'function') {
        updateSystemLogs();
    }

    // Set up periodic updates only if functions exist
    if (typeof updatePerformanceMetrics === 'function') {
        setInterval(updatePerformanceMetrics, 5000);  // Every 5 seconds
    }
    if (typeof updateSecurityMetrics === 'function') {
        setInterval(updateSecurityMetrics, 10000);    // Every 10 seconds
    }
    if (typeof updateDataAnalytics === 'function') {
        setInterval(updateDataAnalytics, 30000);      // Every 30 seconds
    }
    if (typeof updateSystemLogs === 'function') {
        setInterval(updateSystemLogs, 15000);         // Every 15 seconds
    }

    // Set up log filter listeners only if elements exist
    const logLevelFilter = document.getElementById('log-level-filter');
    const logComponentFilter = document.getElementById('log-component-filter');

    if (logLevelFilter && typeof updateSystemLogs === 'function') {
        logLevelFilter.addEventListener('change', updateSystemLogs);
    }
    if (logComponentFilter && typeof updateSystemLogs === 'function') {
        logComponentFilter.addEventListener('change', updateSystemLogs);
    }
});

// New ML Keywords function that actually works
function toggleNewMLKeywords() {
    console.log('toggleNewMLKeywords function called');

    const container = document.getElementById('newMLKeywordsContainer');
    const keywordsDiv = document.getElementById('newMLKeywords');

    if (!container || !keywordsDiv) {
        console.error('Container elements not found');
        alert('Error: Could not find ML Keywords elements');
        return;
    }

    console.log('Found container elements, toggling visibility');

    if (container.style.display === 'none' || container.style.display === '') {
        console.log('Showing ML Keywords container');
        container.style.display = 'block';

        // Show loading state
        keywordsDiv.innerHTML = `
            <div class="card-body">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading ML keywords...</p>
                </div>
            </div>
        `;

        // Fetch ML keywords data
        console.log('Fetching ML keywords from API...');
        fetch('/api/ml-keywords')
            .then(response => {
                console.log('API response received:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('ML Keywords data loaded successfully:', data);

                const totalKeywords = data.total_keywords || 0;
                const categories = data.categories || {};
                const businessCount = categories.Business || 0;
                const personalCount = categories.Personal || 0;
                const suspiciousCount = categories.Suspicious || 0;

                keywordsDiv.innerHTML = `
                    <div class="card-header bg-primary text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-brain me-2"></i>ML Keywords Management
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6>Keywords Summary</h6>
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="h4 text-primary">${totalKeywords}</div>
                                    <small>Total Keywords</small>
                                </div>
                                <div class="col-3">
                                    <div class="h4 text-success">${businessCount}</div>
                                    <small>Business</small>
                                </div>
                                <div class="col-3">
                                    <div class="h4 text-warning">${personalCount}</div>
                                    <small>Personal</small>
                                </div>
                                <div class="col-3">
                                    <div class="h4 text-danger">${suspiciousCount}</div>
                                    <small>Suspicious</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <h6>Sample Keywords by Category:</h6>
                                <div class="row">
                `;

                // Add sample keywords from each category
                if (data.keywords && data.keywords.length > 0) {
                    const businessKeywords = data.keywords.filter(k => k.category === 'Business').slice(0, 5);
                    const personalKeywords = data.keywords.filter(k => k.category === 'Personal').slice(0, 5);
                    const suspiciousKeywords = data.keywords.filter(k => k.category === 'Suspicious').slice(0, 5);

                    keywordsDiv.innerHTML += `
                                    <div class="col-md-4">
                                        <h6 class="text-success">Business Keywords</h6>
                                        ${businessKeywords.map(k => `<span class="badge bg-success me-1 mb-1">${k.keyword} (${k.risk_score})</span>`).join('')}
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-warning">Personal Keywords</h6>
                                        ${personalKeywords.map(k => `<span class="badge bg-warning me-1 mb-1">${k.keyword} (${k.risk_score})</span>`).join('')}
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-danger">Suspicious Keywords</h6>
                                        ${suspiciousKeywords.map(k => `<span class="badge bg-danger me-1 mb-1">${k.keyword} (${k.risk_score})</span>`).join('')}
                                    </div>
                    `;
                }

                keywordsDiv.innerHTML += `
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-sm btn-success" onclick="populateDefaultKeywords()">
                                <i class="fas fa-plus me-1"></i>Populate Default Keywords
                            </button>
                            <button class="btn btn-sm btn-warning ms-2" onclick="showKeywordEditor()">
                                <i class="fas fa-edit me-1"></i>Edit Keywords
                            </button>
                            <button class="btn btn-sm btn-primary ms-2" onclick="toggleNewMLKeywords()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                            <button class="btn btn-sm btn-secondary ms-2" onclick="toggleNewMLKeywords()">
                                <i class="fas fa-times me-1"></i>Close
                            </button>
                        </div>
                    </div>
                `;

                console.log('ML Keywords display updated successfully');
            })
            .catch(error => {
                console.error('Error loading ML keywords:', error);
                keywordsDiv.innerHTML = `
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <h6>Error Loading ML Keywords</h6>
                            <p>Failed to load ML keywords: ${error.message}</p>
                            <button class="btn btn-sm btn-danger" onclick="toggleNewMLKeywords()">Try Again</button>
                        </div>
                    </div>
                `;
            });
    } else {
        console.log('Hiding ML Keywords container');
        container.style.display = 'none';
    }
}

// Exclusion Keywords toggle function
function toggleExclusionKeywords() {
    console.log('toggleExclusionKeywords function called');
    
    const container = document.getElementById('exclusionKeywordsContainer');
    const keywordsDiv = document.getElementById('exclusionKeywords');
    
    if (!container || !keywordsDiv) {
        console.error('Exclusion keywords container elements not found');
        alert('Error: Could not find exclusion keywords elements');
        return;
    }
    
    if (container.style.display === 'none' || container.style.display === '') {
        console.log('Showing Exclusion Keywords container');
        container.style.display = 'block';
        
        // Show loading state
        keywordsDiv.innerHTML = `
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="fas fa-ban me-2"></i>Exclusion Keywords Management
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-info-circle me-1"></i>Exclusion Keywords</h6>
                    <p class="mb-2">Manage keywords that exclude emails from analysis. Emails containing these keywords will be automatically filtered out.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Add Exclusion Keyword:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newExclusionKeyword" placeholder="Enter keyword...">
                                <button class="btn btn-warning" onclick="addExclusionKeyword()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apply to:</label>
                            <select class="form-select" id="exclusionAppliesTo">
                                <option value="both">Subject & Attachments</option>
                                <option value="subject">Subject Only</option>
                                <option value="attachment">Attachments Only</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="exclusionKeywordsList">
                    <div class="text-center py-3">
                        <div class="spinner-border text-warning" role="status"></div>
                        <p class="mt-2">Loading exclusion keywords...</p>
                    </div>
                </div>
            </div>
        `;
        
        // Load exclusion keywords
        loadExclusionKeywords();
    } else {
        console.log('Hiding Exclusion Keywords container');
        container.style.display = 'none';
    }
}

// Manage Wordlists toggle function
function toggleManageWordlists() {
    console.log('toggleManageWordlists function called');
    
    const container = document.getElementById('manageWordlistsContainer');
    const wordlistsDiv = document.getElementById('manageWordlists');
    
    if (!container || !wordlistsDiv) {
        console.error('Manage wordlists container elements not found');
        alert('Error: Could not find manage wordlists elements');
        return;
    }
    
    if (container.style.display === 'none' || container.style.display === '') {
        console.log('Showing Manage Wordlists container');
        container.style.display = 'block';
        
        // Show loading state
        wordlistsDiv.innerHTML = `
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-list-alt me-2"></i>Wordlists Management
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-1"></i>Wordlist Management</h6>
                    <p class="mb-2">Manage custom wordlists for email analysis including attachment scanning and subject line analysis.</p>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <button class="btn btn-success btn-sm w-100" onclick="showAddWordlistModal()">
                                <i class="fas fa-plus me-1"></i>Add New Wordlist
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-info btn-sm w-100" onclick="importWordlist()">
                                <i class="fas fa-upload me-1"></i>Import Wordlist
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary btn-sm w-100" onclick="exportWordlists()">
                                <i class="fas fa-download me-1"></i>Export All
                            </button>
                        </div>
                    </div>
                </div>
                <div id="wordlistsTable">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading wordlists...</p>
                    </div>
                </div>
            </div>
        `;
        
        // Load wordlists
        loadWordlists();
    } else {
        console.log('Hiding Manage Wordlists container');
        container.style.display = 'none';
    }
}

// Helper functions for exclusion keywords
function loadExclusionKeywords() {
    // Placeholder for loading exclusion keywords
    document.getElementById('exclusionKeywordsList').innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-1"></i>
            No exclusion keywords configured yet. Add keywords to automatically exclude emails from analysis.
        </div>
    `;
}

function addExclusionKeyword() {
    const keyword = document.getElementById('newExclusionKeyword').value.trim();
    const appliesTo = document.getElementById('exclusionAppliesTo').value;
    
    if (!keyword) {
        alert('Please enter a keyword');
        return;
    }
    
    alert(`Added exclusion keyword: "${keyword}" (applies to: ${appliesTo})`);
    document.getElementById('newExclusionKeyword').value = '';
    loadExclusionKeywords();
}

// Helper functions for wordlists
function loadWordlists() {
    // Placeholder for loading wordlists
    document.getElementById('wordlistsTable').innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Wordlist Name</th>
                        <th>Type</th>
                        <th>Keywords Count</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">
                            No wordlists configured yet. Click "Add New Wordlist" to get started.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
}

function showAddWordlistModal() {
    alert('Add wordlist functionality will be available soon!');
}

function importWordlist() {
    alert('Import wordlist functionality will be available soon!');
}

function exportWordlists() {
    alert('Export wordlists functionality will be available soon!');
}

// Keyword Editor Functions
function showKeywordEditor() {
    console.log('Opening keyword editor...');
    const modal = new bootstrap.Modal(document.getElementById('keywordEditorModal'));
    modal.show();
    loadKeywordsForEditing();
}

function loadKeywordsForEditing() {
    const keywordsList = document.getElementById('keywordsList');
    keywordsList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Loading keywords...</p></div>';

    fetch('/api/ml-keywords/all')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                keywordsList.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            if (data.keywords.length === 0) {
                keywordsList.innerHTML = '<div class="text-center text-muted"><p>No keywords found. Add some keywords above.</p></div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Keyword</th><th>Category</th><th>Risk Score</th><th>Actions</th></tr></thead><tbody>';

            data.keywords.forEach(keyword => {
                const categoryClass = keyword.category === 'Business' ? 'success' : 
                                    keyword.category === 'Personal' ? 'warning' : 'danger';

                html += `
                    <tr id="keyword-${keyword.id}">
                        <td>
                            <input type="text" class="form-control form-control-sm" value="${keyword.keyword}" 
                                   onchange="updateKeywordField(${keyword.id}, 'keyword', this.value)">
                        </td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="updateKeywordField(${keyword.id}, 'category', this.value)">
                                <option value="Business" ${keyword.category === 'Business' ? 'selected' : ''}>Business</option>
                                <option value="Personal" ${keyword.category === 'Personal' ? 'selected' : ''}>Personal</option>
                                <option value="Suspicious" ${keyword.category === 'Suspicious' ? 'selected' : ''}>Suspicious</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm" value="${keyword.risk_score}" 
                                   min="1" max="10" style="width: 70px;"
                                   onchange="updateKeywordField(${keyword.id}, 'risk_score', this.value)">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteKeyword(${keyword.id}, '${keyword.keyword}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            keywordsList.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading keywords:', error);
            keywordsList.innerHTML = '<div class="alert alert-danger">Failed to load keywords</div>';
        });
}

function addKeywords() {
    const activeTab = document.querySelector('#keywordTabs .nav-link.active').id;

    if (activeTab === 'single-tab') {
        addSingleKeyword();
    } else {
        addBulkKeywords();
    }
}

function addSingleKeyword() {
    const keyword = document.getElementById('newKeywordText').value.trim();
    const category = document.getElementById('newKeywordCategory').value;
    const riskScore = parseInt(document.getElementById('newKeywordRisk').value);

    if (!keyword) {
        showError('Please enter a keyword');
        return;
    }

    if (riskScore < 1 || riskScore > 10) {
        showError('Risk score must be between 1 and 10');
        return;
    }

    fetch('/api/ml-keywords/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            keyword: keyword,
            category: category,
            risk_score: riskScore
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            // Clear form
            document.getElementById('newKeywordText').value = '';
            document.getElementById('newKeywordRisk').value = '5';
            // Refresh the keywords list
            loadKeywordsForEditing();
        } else {
            showError(data.error || 'Failed to add keyword');
        }
    })
    .catch(error => {
        console.error('Error adding keyword:', error);
        showError('Failed to add keyword');
    });
}

function addBulkKeywords() {
    const keywordsText = document.getElementById('bulkKeywordsText').value.trim();
    const category = document.getElementById('bulkKeywordCategory').value;
    const riskScore = parseInt(document.getElementById('bulkKeywordRisk').value);

    if (!keywordsText) {
        showAlert('Please enter keywords', 'danger');
        return;
    }

    if (riskScore < 1 || riskScore > 10) {
        showAlert('Risk score must be between 1 and 10', 'danger');
        return;
    }

    // Parse keywords - handle both line breaks and commas
    let keywords = [];

    // First split by lines
    const lines = keywordsText.split('\n');
    for (let line of lines) {
        line = line.trim();
        if (line) {
            // Then split each line by commas
            const commaSplit = line.split(',');
            for (let keyword of commaSplit) {
                keyword = keyword.trim();
                if (keyword && keyword.length > 0) {
                    // Check for duplicates case-insensitive
                    const keywordLower = keyword.toLowerCase();
if (!keywords.some(k => k.toLowerCase() === keywordLower)) {
                        keywords.push(keyword);
                    }
                }
            }
        }
    }

    if (keywords.length === 0) {
        showAlert('No valid keywords found', 'danger');
        return;
    }

    if (keywords.length > 100) {
        showAlert('Maximum 100 keywords allowed per bulk import', 'danger');
        return;
    }

    // Show progress
    const addButton = event.target;
    const originalText = addButton.innerHTML;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Keywords...';
    addButton.disabled = true;

    console.log('Adding bulk keywords:', keywords);

    // Send bulk request
    fetch('/api/ml-keywords/bulk-add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            keywords: keywords,
            category: category,
            risk_score: riskScore
        })
    })
    .then(response => {
        console.log('Bulk add response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Bulk add response data:', data);
        if (data.success) {
            const message = `Successfully added ${data.added_count} keywords`;
            if (data.skipped_count > 0) {
                message += ` (${data.skipped_count} duplicates skipped)`;
            }
            if (data.errors && data.errors.length > 0) {
                message += `. ${data.errors.length} errors occurred.`;
                console.log('Bulk add errors:', data.errors);
            }
            showAlert(message, 'success');

            // Clear form
            document.getElementById('bulkKeywordsText').value = '';
            document.getElementById('bulkKeywordRisk').value = '5';

            // Refresh both the keywords list in the modal AND the main keywords display
            loadKeywordsForEditing();

            // If the main ML keywords panel is open, refresh it too
            if (document.getElementById('newMLKeywordsContainer').style.display !== 'none') {
                setTimeout(() => {
                    toggleNewMLKeywords(); // Close it
                    setTimeout(() => toggleNewMLKeywords(), 500); // Re-open it
                }, 1000);
            }
        } else {
            showAlert(data.error || 'Failed to add keywords', 'danger');
        }
    })
    .catch(error => {
        console.error('Error adding keywords:', error);
        showAlert('Failed to add keywords: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restore button
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    });
}

function updateKeywordField(keywordId, field, value) {
    const data = {};
    data[field] = field === 'risk_score' ? parseInt(value) : value;

    fetch(`/api/ml-keywords/update/${keywordId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Keyword updated successfully');
        } else {
            showAlert('Error: ' + (data.error || data.message), 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating keyword:', error);
        showAlert('Failed to update keyword', 'danger');
    });
}

function deleteKeyword(keywordId, keywordName) {
    if (!confirm(`Are you sure you want to delete the keyword "${keywordName}"?`)) {
        return;
    }

    fetch(`/api/ml-keywords/delete/${keywordId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`keyword-${keywordId}`).remove();
            showAlert('Keyword deleted successfully', 'success');
        } else {
            showAlert('Error: ' + (data.error || data.message), 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting keyword:', error);
        showAlert('Failed to delete keyword', 'danger');
    });
}

function saveAllKeywords() {
    const saveButton = document.querySelector('[onclick="saveAllKeywords()"]');
    const originalText = saveButton.innerHTML;

    // Show saving state
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    saveButton.disabled = true;

    // Collect all keyword data from the table
    const keywordRows = document.querySelectorAll('#keywordsList tbody tr');
    const updates = [];
    let hasChanges = false;

    keywordRows.forEach(row => {
        const keywordId = row.id.split('-')[1];
        const keywordInput = row.querySelector('input[type="text"]');
        const categorySelect = row.querySelector('select');
        const riskInput = row.querySelector('input[type="number"]');

        if (keywordInput && categorySelect && riskInput) {
            updates.push({
                id: keywordId,
                keyword: keywordInput.value.trim(),
                category: categorySelect.value,
                risk_score: parseInt(riskInput.value)
            });
            hasChanges = true;
        }
    });

    if (!hasChanges) {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
        showAlert('No changes to save', 'info');
        return;
    }

    // Save all updates
    Promise.all(updates.map(update => 
        fetch(`/api/ml-keywords/update/${update.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                keyword: update.keyword,
                category: update.category,
                risk_score: update.risk_score
            })
        }).then(response => response.json())
    ))
    .then(results => {
        const errors = results.filter(r => !r.success);

        if (errors.length === 0) {
            showAlert(`Successfully saved all ${updates.length} keywords`, 'success');

            // Refresh the main ML keywords display if it's open
            if (document.getElementById('newMLKeywordsContainer').style.display !== 'none') {
                toggleNewMLKeywords();
                setTimeout(() => toggleNewMLKeywords(), 500);
            }
        } else {
            showAlert(`Saved ${updates.length - errors.length} keywords, ${errors.length} failed`, 'warning');
        }
    })
    .catch(error => {
        console.error('Error saving keywords:', error);
        showAlert('Error saving keywords: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restore button
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 4000);
}

// Risk Factor Management Functions
function viewRiskFactorSimple(element) {
    const id = element.getAttribute('data-factor-id');
    const name = element.getAttribute('data-factor-name');
    const description = element.getAttribute('data-factor-description');
    const maxScore = parseFloat(element.getAttribute('data-factor-max-score'));
    const category = element.getAttribute('data-factor-category');
    const weightPercentage = parseFloat(element.getAttribute('data-factor-weight'));

    // Find the hidden config script for this factor
    let calculationConfig = {};
    const configScript = element.querySelector('.risk-factor-config[data-factor-id="' + id + '"]');
    if (configScript) {
        try {
            calculationConfig = JSON.parse(configScript.textContent.trim());
            console.log('Found calculation config:', calculationConfig);
        } catch (error) {
            console.warn('Could not parse calculation config:', error);
        }
    } else {
        console.warn('No config script found for factor ID:', id);
    }

    viewRiskFactorDetails(id, name, description, maxScore, category, weightPercentage, calculationConfig);
}

// Configuration editing helper functions
function showConfigTemplates() {
    const templates = {
        'Binary Field Check': {
            "field": "leaver",
            "trigger_values": ["yes", "true", "1"],
            "score_calculation": "binary"
        },
        'Pattern Matching': {
            "field": "recipients_email_domain",
            "patterns": ["gmail", "yahoo", "hotmail", "outlook"],
            "score_calculation": "pattern_match"
        },
        'Attachment Analysis': {
            "field": "attachments",
            "high_risk_extensions": [".exe", ".scr", ".bat"],
            "medium_risk_extensions": [".zip", ".rar"],
            "score_calculation": "attachment_analysis"
        },
        'Keyword Analysis': {
            "fields": ["wordlist_subject", "wordlist_attachment"],
            "score_calculation": "keyword_analysis"
        },
        'Text Analysis': {
            "field": "justification",
            "suspicious_patterns": ["personal use", "backup", "external"],
            "score_calculation": "text_analysis"
        },
        'Time-based Risk': {
            "field": "time",
            "risk_periods": ["weekend", "after_hours"],
            "score_calculation": "time_analysis"
        }
    };

    let templateOptions = '<div class="row">';
    Object.keys(templates).forEach((templateName, index) => {
        if (index % 2 === 0 && index > 0) templateOptions += '</div><div class="row">';
        templateOptions += `
            <div class="col-md-6 mb-2">
                <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="applyConfigTemplate('${templateName}')">
                    <i class="fas fa-copy me-1"></i>${templateName}
                </button>
            </div>
        `;
    });
    templateOptions += '</div>';

    document.getElementById('configHints').innerHTML = `
        <div class="card border-info">
            <div class="card-header bg-info text-white py-2">
                <h6 class="mb-0"><i class="fas fa-lightbulb me-1"></i>Configuration Templates</h6>
            </div>
            <div class="card-body py-2">
                ${templateOptions}
                <hr class="my-2">
                <small class="text-muted">Click a template to copy its JSON structure to the configuration field.</small>
            </div>
        </div>
    `;
    document.getElementById('configHints').style.display = 'block';

    // Store templates for later use
    window.configTemplatesData = templates;
}

function applyConfigTemplate(templateName) {
    if (window.configTemplatesData && window.configTemplatesData[templateName]) {
        const config = window.configTemplatesData[templateName];
        document.getElementById('riskFactorConfig').value = JSON.stringify(config, null, 2);
        validateConfigJSON();
        showSuccess(`Applied "${templateName}" template`);
    }
}

function validateConfigJSON() {
    const configText = document.getElementById('riskFactorConfig').value.trim();
    const feedbackDiv = document.getElementById('configValidationFeedback');

    if (!configText) {
        feedbackDiv.innerHTML = '<div class="alert alert-warning alert-sm py-1"><i class="fas fa-exclamation-triangle me-1"></i>Configuration is empty</div>';
        return false;
    }

    try {
        const config = JSON.parse(configText);

        // Validate common structure
        let issues = [];
        let suggestions = [];

        // Check for required fields
        if (!config.field && !config.fields) {
            issues.push('Missing "field" or "fields" property');
        }

        if (!config.score_calculation) {
            suggestions.push('Consider adding "score_calculation" method');
        }

        // Check field types
        if (config.trigger_values && !Array.isArray(config.trigger_values)) {
            issues.push('"trigger_values" should be an array');
        }

        if (config.patterns && !Array.isArray(config.patterns)) {
            issues.push('"patterns" should be an array');
        }

        if (issues.length === 0) {
            feedbackDiv.innerHTML = `
                <div class="alert alert-success alert-sm py-1">
                    <i class="fas fa-check-circle me-1"></i>Valid JSON configuration
                    ${suggestions.length > 0 ? '<br><small>' + suggestions.join(', ') + '</small>' : ''}
                </div>
            `;
            return true;
        } else {
            feedbackDiv.innerHTML = `
                <div class="alert alert-danger alert-sm py-1">
                    <i class="fas fa-exclamation-circle me-1"></i>Issues found: ${issues.join(', ')}
                </div>
            `;
            return false;
        }

    } catch (error) {
        feedbackDiv.innerHTML = `
            <div class="alert alert-danger alert-sm py-1">
                <i class="fas fa-times-circle me-1"></i>Invalid JSON: ${error.message}
            </div>
        `;
        return false;
    }
}

function formatConfigJSON() {
    const configText = document.getElementById('riskFactorConfig').value.trim();

    if (!configText) {
        showAlert('Configuration is empty - nothing to format', 'warning');
        return;
    }

    try {
        const config = JSON.parse(configText);
        document.getElementById('riskFactorConfig').value = JSON.stringify(config, null, 2);
        showSuccess('JSON formatted successfully');
        validateConfigJSON();
    } catch (error) {
        showAlert('Cannot format invalid JSON: ' + error.message, 'danger');
    }
}

function setupConfigEditor() {
    const configTextarea = document.getElementById('riskFactorConfig');

    // Add event listeners for real-time validation
    configTextarea.addEventListener('input', debounce(validateConfigJSON, 500));
    configTextarea.addEventListener('blur', validateConfigJSON);

    // Add keyboard shortcuts
    configTextarea.addEventListener('keydown', function(e) {
        // Ctrl+S to format
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            formatConfigJSON();
        }

        // Tab support for better editing
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;

            this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 2;
        }
    });
}

// Debounce function for performance
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function viewRiskFactorDetails(id, name, description, maxScore, category, weightPercentage, calculationConfig) {
    document.getElementById('riskFactorId').value = id || '';
    document.getElementById('riskFactorName').value = name;
    document.getElementById('riskFactorDescription').value = description;
    document.getElementById('riskFactorMaxScore').value = maxScore;
    document.getElementById('riskFactorCategory').value = category;
    document.getElementById('riskFactorWeight').value = weightPercentage;

    // Handle calculation config
    if (calculationConfig && typeof calculationConfig === 'object') {
        document.getElementById('riskFactorConfig').value = JSON.stringify(calculationConfig, null, 2);
    } else {
        document.getElementById('riskFactorConfig').value = '';
    }

    // Add real-time validation
    setTimeout(() => {
        setupConfigEditor();
        validateConfigJSON();
    }, 100);

    // Update modal title and buttons based on whether it's new or existing
    const modalTitle = document.getElementById('riskFactorModalTitle');
    const saveButton = document.getElementById('saveRiskFactorBtn');
    const deleteButton = document.getElementById('deleteRiskFactorBtn');

    if (id) {
        modalTitle.textContent = 'Edit Risk Factor';
        saveButton.textContent = 'Update Factor';
        deleteButton.style.display = 'inline-block';
    } else {
        modalTitle.textContent = 'View Risk Factor';
        saveButton.textContent = 'Save Changes';
        deleteButton.style.display = 'none';
    }

    const modal = new bootstrap.Modal(document.getElementById('riskFactorModal'));
    modal.show();
}

function showAddRiskFactorModal() {
    // Clear form for new factor
    document.getElementById('riskFactorId').value = '';
    document.getElementById('riskFactorName').value = '';
    document.getElementById('riskFactorDescription').value = '';
    document.getElementById('riskFactorMaxScore').value = '0.1';
    document.getElementById('riskFactorCategory').value = 'General';
    document.getElementById('riskFactorWeight').value = '0.0';
    document.getElementById('riskFactorConfig').value = '';

    const modalTitle = document.getElementById('riskFactorModalTitle');
    const saveButton = document.getElementById('saveRiskFactorBtn');
    const deleteButton = document.getElementById('deleteRiskFactorBtn');

    modalTitle.textContent = 'Add New Risk Factor';
    saveButton.textContent = 'Add Factor';
    deleteButton.style.display = 'none';

    const modal = new bootstrap.Modal(document.getElementById('riskFactorModal'));
    modal.show();
}

function saveRiskFactor() {
    const id = document.getElementById('riskFactorId').value;
    const name = document.getElementById('riskFactorName').value.trim();
    const description = document.getElementById('riskFactorDescription').value.trim();
    const maxScore = parseFloat(document.getElementById('riskFactorMaxScore').value);
    const category = document.getElementById('riskFactorCategory').value;
    const weightPercentage = parseFloat(document.getElementById('riskFactorWeight').value);
    const configText = document.getElementById('riskFactorConfig').value.trim();

    if (!name || !description) {
        showAlert('Name and description are required', 'danger');
        return;
    }

    if (maxScore < 0.0 || maxScore > 1.0) {
        showAlert('Max score must be between 0.0 and 1.0', 'danger');
        return;
    }

    if (weightPercentage < 0.0 || weightPercentage > 100.0) {
        showAlert('Weight percentage must be between 0.0 and 100.0', 'danger');
        return;
    }

    // Parse and validate calculation config JSON
    let calculationConfig = {};
    if (configText) {
        try {
            calculationConfig = JSON.parse(configText);

            // Validate the configuration structure
            if (!validateConfigJSON()) {
                showAlert('Please fix the configuration issues before saving', 'danger');
                return;
            }
        } catch (error) {
            showAlert('Invalid JSON in implementation configuration: ' + error.message, 'danger');
            return;
        }
    }

    const data = {
        name: name,
        description: description,
        max_score: maxScore,
        category: category,
        weight_percentage: weightPercentage,
        calculation_config: calculationConfig
    };

    const url = id ? `/api/risk-factors/update/${id}` : '/api/risk-factors/add';
    const method = id ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('riskFactorModal')).hide();
            // Refresh the page to show updated factors
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving risk factor:', error);
        showAlert('Failed to save risk factor', 'danger');
    });
}

function deleteRiskFactor() {
    const id = document.getElementById('riskFactorId').value;
    const name = document.getElementById('riskFactorName').value;

    if (!id) {
        showAlert('Cannot delete: No factor ID found', 'danger');
        return;
    }

    if (!confirm(`Are you sure you want to delete the risk factor "${name}"? This action cannot be undone.`)) {
        return;
    }

    fetch(`/api/risk-factors/delete/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('riskFactorModal')).hide();
            // Refresh the page to show updated factors
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting risk factor:', error);
        showAlert('Failed to delete risk factor', 'danger');
    });
}

function populateDefaultRiskFactors() {
    if (!confirm('This will add default risk factors to the database. Continue?')) {
        return;
    }

    fetch('/admin/risk-factors/populate', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Refresh the page to show new factors
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error populating risk factors:', error);
        showAlert('Failed to populate risk factors', 'danger');
    });
}
</script>

<!-- Risk Factor Management Modal -->
<div class="modal fade" id="riskFactorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="riskFactorModalTitle">
                    <i class="fas fa-cog me-2"></i>Risk Factor Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="riskFactorId">

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="riskFactorName" class="form-label">Factor Name</label>
                            <input type="text" class="form-control" id="riskFactorName" placeholder="e.g., Leaver Status">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="riskFactorCategory" class="form-label">Category</label>
                            <select class="form-control" id="riskFactorCategory">
                                <option value="General">General</option>
                                <option value="Security">Security</option>
                                <option value="Content">Content</option>
                                <option value="Time">Time</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="riskFactorDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="riskFactorDescription" rows="3" placeholder="Describe what this risk factor detects..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="riskFactorMaxScore" class="form-label">Maximum Score</label>
                            <input type="number" class="form-control" id="riskFactorMaxScore" min="0.0" max="1.0" step="0.1" placeholder="0.0 - 1.0">
                            <small class="text-muted">Maximum risk score this factor can contribute (0.0 - 1.0)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="riskFactorWeight" class="form-label">Weight Percentage</label>
                            <input type="number" class="form-control" id="riskFactorWeight" min="0.0" max="100.0" step="1.0" placeholder="0.0 - 100.0">
                            <small class="text-muted">Percentage of total risk score (0.0 - 100.0%)</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                Implementation Configuration
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info" onclick="showConfigTemplates()">
                                        <i class="fas fa-lightbulb me-1"></i>Templates
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="validateConfigJSON()">
                                        <i class="fas fa-check me-1"></i>Validate
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="formatConfigJSON()">
                                        <i class="fas fa-code me-1"></i>Format
                                    </button>
                                </div>
                            </label>
                            <textarea class="form-control font-monospace" id="riskFactorConfig" rows="8" placeholder="JSON configuration for how this factor is calculated..." style="background-color: #f8f9fa; border: 2px solid #dee2e6;"></textarea>
                            <div id="configValidationFeedback" class="mt-2"></div>
                            <div class="mt-2">
                                <small class="text-muted d-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Common Fields:</strong> field, fields, trigger_values, patterns, suspicious_patterns, score_calculation
                                </small>
                                <div class="mt-1" id="configHints" style="display: none;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-1"></i>How Risk Factors Work</h6>
                        <ul class="mb-0 small">
                            <li><strong>Maximum Score:</strong> The highest risk score this factor can contribute to an email's total risk</li>
                            <li><strong>Weight Percentage:</strong> How much this factor influences the overall risk calculation</li>
                            <li><strong>Category:</strong> Groups similar factors for better organization and analysis</li>
                            <li><strong>Implementation:</strong> JSON config defines fields to check, trigger values, and calculation methods</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteRiskFactorBtn" onclick="deleteRiskFactor()">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveRiskFactorBtn" onclick="saveRiskFactor()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}