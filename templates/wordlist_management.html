{% extends "base.html" %}

{% block title %}Wordlist Management - Email Guardian{% endblock %}

{% block extra_head %}
<style>
    .keyword-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .keyword-card:hover {
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .category-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .category-business { background: #d1ecf1; color: #0c5460; }
    .category-personal { background: #fff3cd; color: #856404; }
    .category-suspicious { background: #f8d7da; color: #721c24; }
    
    .type-badge {
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .type-risk { background: #d4edda; color: #155724; }
    .type-exclusion { background: #f8d7da; color: #721c24; }
    
    .applies-to-badge {
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.7rem;
        background: #e9ecef;
        color: #495057;
    }
    
    .risk-score {
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .risk-score-1 { background: #d4edda; color: #155724; }
    .risk-score-2 { background: #fff3cd; color: #856404; }
    .risk-score-3 { background: #ffeaa7; color: #856404; }
    .risk-score-4 { background: #fab1a0; color: #721c24; }
    .risk-score-5 { background: #f8d7da; color: #721c24; }
    
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .add-keyword-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px dashed #dee2e6;
    }
    
    .stats-card {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .stats-risk { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .stats-exclusion { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
    .stats-total { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin') }}">Admin</a></li>
<li class="breadcrumb-item active">Wordlist Management</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="section-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-list-alt me-3"></i>Wordlist Management
                </h1>
                <p class="mb-0">Manage risk keywords and exclusion keywords for email analysis</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <button class="btn btn-light btn-lg" onclick="showAddKeywordModal()">
                        <i class="fas fa-plus me-2"></i>Add Keyword
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="showBulkImportModal()">
                        <i class="fas fa-upload me-2"></i>Bulk Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card stats-total">
                <h3>{{ (risk_keywords|length) + (exclusion_keywords|length) }}</h3>
                <p class="mb-0">Total Keywords</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card stats-risk">
                <h3>{{ risk_keywords|length }}</h3>
                <p class="mb-0">Risk Keywords</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card stats-exclusion">
                <h3>{{ exclusion_keywords|length }}</h3>
                <p class="mb-0">Exclusion Keywords</p>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <ul class="nav nav-tabs" id="wordlistTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk-keywords" type="button" role="tab">
                <i class="fas fa-exclamation-triangle me-2"></i>Risk Keywords ({{ risk_keywords|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="exclusion-tab" data-bs-toggle="tab" data-bs-target="#exclusion-keywords" type="button" role="tab">
                <i class="fas fa-ban me-2"></i>Exclusion Keywords ({{ exclusion_keywords|length }})
            </button>
        </li>
    </ul>

    <div class="tab-content" id="wordlistTabContent">
        <!-- Risk Keywords Tab -->
        <div class="tab-pane fade show active" id="risk-keywords" role="tabpanel">
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-brain text-primary me-2"></i>Risk Keywords</h4>
                    <small class="text-muted">Keywords that increase email risk scores</small>
                </div>
                
                {% if risk_by_category %}
                    {% for category, keywords in risk_by_category.items() %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <span class="category-badge category-{{ category.lower() }}">{{ category }}</span>
                                <span class="ms-2">{{ keywords|length }} keywords</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for keyword in keywords %}
                                <div class="col-md-6 col-lg-4 mb-2">
                                    <div class="keyword-card p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ keyword.keyword }}</strong>
                                                <div class="mt-1">
                                                    <span class="type-badge type-{{ keyword.keyword_type }}">{{ keyword.keyword_type.title() }}</span>
                                                    <span class="applies-to-badge ms-1">{{ keyword.applies_to }}</span>
                                                    <span class="risk-score risk-score-{{ keyword.risk_score }} ms-1">Risk: {{ keyword.risk_score }}</span>
                                                </div>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="editKeyword({{ keyword.id }})">
                                                        <i class="fas fa-edit me-2"></i>Edit
                                                    </a></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteKeyword({{ keyword.id }})">
                                                        <i class="fas fa-trash me-2"></i>Delete
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No risk keywords configured yet. Click "Add Keyword" to get started.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Exclusion Keywords Tab -->
        <div class="tab-pane fade" id="exclusion-keywords" role="tabpanel">
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-shield-alt text-warning me-2"></i>Exclusion Keywords</h4>
                    <small class="text-muted">Keywords that exclude emails from analysis</small>
                </div>
                
                {% if exclusion_by_applies_to %}
                    {% for applies_to, keywords in exclusion_by_applies_to.items() %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <span class="applies-to-badge">Applies to: {{ applies_to.title() }}</span>
                                <span class="ms-2">{{ keywords|length }} keywords</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for keyword in keywords %}
                                <div class="col-md-6 col-lg-4 mb-2">
                                    <div class="keyword-card p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ keyword.keyword }}</strong>
                                                <div class="mt-1">
                                                    <span class="type-badge type-{{ keyword.keyword_type }}">{{ keyword.keyword_type.title() }}</span>
                                                    <span class="category-badge category-{{ keyword.category.lower() }} ms-1">{{ keyword.category }}</span>
                                                </div>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="editKeyword({{ keyword.id }})">
                                                        <i class="fas fa-edit me-2"></i>Edit
                                                    </a></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteKeyword({{ keyword.id }})">
                                                        <i class="fas fa-trash me-2"></i>Delete
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No exclusion keywords configured yet. Click "Add Keyword" to get started.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Keyword Modal -->
<div class="modal fade" id="keywordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keywordModalTitle">
                    <i class="fas fa-plus-circle me-2"></i>Add New Keyword
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="keywordForm">
                    <input type="hidden" id="keywordId">
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="keywordText" class="form-label">Keyword *</label>
                            <input type="text" class="form-control" id="keywordText" placeholder="Enter keyword..." required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="keywordType" class="form-label">Type *</label>
                            <select class="form-select" id="keywordType" onchange="toggleTypeOptions()">
                                <option value="risk">Risk Keyword</option>
                                <option value="exclusion">Exclusion Keyword</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="keywordCategory" class="form-label">Category</label>
                            <select class="form-select" id="keywordCategory">
                                <option value="Business">Business</option>
                                <option value="Personal">Personal</option>
                                <option value="Suspicious">Suspicious</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="appliesTo" class="form-label">Applies To</label>
                            <select class="form-select" id="appliesTo">
                                <option value="both">Subject & Attachments</option>
                                <option value="subject">Subject Only</option>
                                <option value="attachment">Attachments Only</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" id="riskScoreRow">
                        <div class="col-md-6 mb-3">
                            <label for="riskScore" class="form-label">Risk Score (1-10)</label>
                            <input type="number" class="form-control" id="riskScore" min="1" max="10" value="1">
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-1"></i>Keyword Types</h6>
                        <ul class="mb-0 small">
                            <li><strong>Risk Keywords:</strong> Increase the risk score when found in emails</li>
                            <li><strong>Exclusion Keywords:</strong> Automatically exclude emails from analysis</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKeyword()">
                    <i class="fas fa-save me-1"></i>Save Keyword
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal fade" id="bulkImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Bulk Import Keywords
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkImportForm">
                    <div class="mb-3">
                        <label for="bulkKeywordType" class="form-label">Keyword Type</label>
                        <select class="form-select" id="bulkKeywordType" name="keyword_type" required>
                            <option value="risk">Risk Keywords</option>
                            <option value="exclusion">Exclusion Keywords</option>
                        </select>
                    </div>
                    
                    <div id="bulkRiskOptions" class="mb-3">
                        <label for="bulkCategory" class="form-label">Category</label>
                        <select class="form-select" id="bulkCategory" name="category">
                            <option value="Business">Business</option>
                            <option value="Personal">Personal</option>
                            <option value="Suspicious">Suspicious</option>
                        </select>
                    </div>
                    
                    <div id="bulkRiskOptionsAdvanced" class="mb-3">
                        <label for="bulkRiskScore" class="form-label">Risk Score (1-5)</label>
                        <select class="form-select" id="bulkRiskScore" name="risk_score">
                            <option value="1">1 - Very Low</option>
                            <option value="2">2 - Low</option>
                            <option value="3" selected>3 - Medium</option>
                            <option value="4">4 - High</option>
                            <option value="5">5 - Critical</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bulkAppliesTo" class="form-label">Applies To</label>
                        <select class="form-select" id="bulkAppliesTo" name="applies_to" required>
                            <option value="both">Both Subject and Attachments</option>
                            <option value="subject">Subject Only</option>
                            <option value="attachment">Attachments Only</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bulkKeywords" class="form-label">Keywords</label>
                        <textarea class="form-control" id="bulkKeywords" name="keywords" rows="8" 
                                  placeholder="Enter keywords, one per line or separated by commas.&#10;Examples:&#10;cv&#10;private invoice&#10;confidential, salary, payroll&#10;personal data&#10;resignation letter" required></textarea>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter keywords one per line or separated by commas. Multi-word phrases like "private invoice" are supported.
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tip:</strong> You can mix single words and phrases. The system will automatically handle both "cv" and "private invoice" correctly.
                    </div>
                </form>
                
                <div id="bulkPreview" style="display: none;" class="mt-3">
                    <h6><i class="fas fa-eye me-2"></i>Preview Keywords to Import</h6>
                    <div id="bulkPreviewList" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;"></div>
                    <small class="text-muted" id="bulkPreviewCount"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="previewBulkImport()">
                    <i class="fas fa-eye me-1"></i>Preview
                </button>
                <button type="button" class="btn btn-primary" onclick="saveBulkKeywords()">
                    <i class="fas fa-upload me-1"></i>Import Keywords
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Show add keyword modal
function showAddKeywordModal() {
    document.getElementById('keywordModalTitle').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add New Keyword';
    document.getElementById('keywordForm').reset();
    document.getElementById('keywordId').value = '';
    new bootstrap.Modal(document.getElementById('keywordModal')).show();
}

// Toggle options based on keyword type
function toggleTypeOptions() {
    const keywordType = document.getElementById('keywordType').value;
    const riskScoreRow = document.getElementById('riskScoreRow');
    
    if (keywordType === 'risk') {
        riskScoreRow.style.display = 'block';
    } else {
        riskScoreRow.style.display = 'none';
    }
}

// Save keyword
function saveKeyword() {
    const keywordId = document.getElementById('keywordId').value;
    const isEdit = keywordId !== '';
    
    const data = {
        keyword: document.getElementById('keywordText').value.trim(),
        keyword_type: document.getElementById('keywordType').value,
        category: document.getElementById('keywordCategory').value,
        applies_to: document.getElementById('appliesTo').value,
        risk_score: parseInt(document.getElementById('riskScore').value) || 1
    };
    
    if (!data.keyword) {
        alert('Please enter a keyword');
        return;
    }
    
    const url = isEdit ? `/api/wordlist/${keywordId}` : '/api/wordlist/add';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('keywordModal')).hide();
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving keyword');
    });
}

// Edit keyword
function editKeyword(keywordId) {
    // This would need to fetch the keyword data and populate the form
    alert('Edit functionality will be enhanced in the next update!');
}

// Delete keyword
function deleteKeyword(keywordId) {
    if (confirm('Are you sure you want to delete this keyword?')) {
        fetch(`/api/wordlist/${keywordId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting keyword');
        });
    }
}

// Show bulk import modal
function showBulkImportModal() {
    document.getElementById('bulkImportForm').reset();
    document.getElementById('bulkPreview').style.display = 'none';
    toggleBulkTypeOptions();
    new bootstrap.Modal(document.getElementById('bulkImportModal')).show();
}

// Toggle bulk import options based on keyword type
function toggleBulkTypeOptions() {
    const keywordType = document.getElementById('bulkKeywordType').value;
    const riskOptions = document.getElementById('bulkRiskOptions');
    const riskOptionsAdvanced = document.getElementById('bulkRiskOptionsAdvanced');
    
    if (keywordType === 'risk') {
        riskOptions.style.display = 'block';
        riskOptionsAdvanced.style.display = 'block';
    } else {
        riskOptions.style.display = 'none';
        riskOptionsAdvanced.style.display = 'none';
    }
}

// Preview bulk import keywords
function previewBulkImport() {
    const keywordsText = document.getElementById('bulkKeywords').value.trim();
    if (!keywordsText) {
        alert('Please enter some keywords to preview.');
        return;
    }
    
    // Parse keywords from text (support both line breaks and commas)
    const keywords = parseKeywords(keywordsText);
    
    if (keywords.length === 0) {
        alert('No valid keywords found. Please check your input.');
        return;
    }
    
    // Display preview
    const previewDiv = document.getElementById('bulkPreview');
    const previewList = document.getElementById('bulkPreviewList');
    const previewCount = document.getElementById('bulkPreviewCount');
    
    previewList.innerHTML = '';
    keywords.forEach((keyword, index) => {
        const span = document.createElement('span');
        span.className = 'badge bg-primary me-2 mb-1';
        span.textContent = keyword;
        previewList.appendChild(span);
    });
    
    previewCount.textContent = `Found ${keywords.length} keyword(s) to import`;
    previewDiv.style.display = 'block';
}

// Parse keywords from textarea input
function parseKeywords(text) {
    const keywords = [];
    
    // Split by both newlines and commas, then clean up
    const rawKeywords = text.split(/[\n,;]+/);
    
    rawKeywords.forEach(keyword => {
        const cleaned = keyword.trim();
        if (cleaned && cleaned.length > 0) {
            // Remove quotes if present
            const finalKeyword = cleaned.replace(/^["']|["']$/g, '');
            if (finalKeyword && !keywords.includes(finalKeyword)) {
                keywords.push(finalKeyword);
            }
        }
    });
    
    return keywords;
}

// Save bulk keywords
async function saveBulkKeywords() {
    const form = document.getElementById('bulkImportForm');
    const keywordsText = document.getElementById('bulkKeywords').value.trim();
    
    if (!keywordsText) {
        alert('Please enter some keywords to import.');
        return;
    }
    
    const keywords = parseKeywords(keywordsText);
    if (keywords.length === 0) {
        alert('No valid keywords found. Please check your input.');
        return;
    }
    
    const formData = new FormData(form);
    const bulkData = {
        keyword_type: formData.get('keyword_type'),
        category: formData.get('category'),
        risk_score: parseInt(formData.get('risk_score')),
        applies_to: formData.get('applies_to'),
        keywords: keywords
    };
    
    try {
        const response = await fetch('/api/wordlist/bulk-import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bulkData)
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(`Successfully imported ${data.imported_count} keywords!`);
            bootstrap.Modal.getInstance(document.getElementById('bulkImportModal')).hide();
            window.location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error importing keywords');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleTypeOptions();
    
    // Add event listener for bulk keyword type change
    document.getElementById('bulkKeywordType').addEventListener('change', toggleBulkTypeOptions);
});
</script>
{% endblock %}